<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartRoute - Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="https://i.postimg.cc/4dNYygZr/Smart-Route-Logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary-blue: #0A3D62;
            --accent-blue: #2980B9;
            --light-bg: #F7F9FC;
            --text-primary: #1A202C;
            --text-secondary: #5A6A7B;
            --border-color: #E2E8F0;
            --danger-red: #E53E3E;
            --danger-red-light: #FFF5F5;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-bg); }
        .nav-item.active {
            color: var(--primary-blue);
            background-color: #EFF6FF;
            font-weight: 600;
        }
        .logo-img { object-fit: contain; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #d1d5db;
            border-bottom-color: var(--primary-blue); border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .map-view-toggle.active, .date-filter-btn.active, .report-tab.active {
            background-color: var(--primary-blue);
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        @keyframes flash-red {
            0%, 100% { color: var(--text-secondary); }
            50% { color: var(--danger-red); }
        }
        .panic-alert-active {
            animation: flash-red 1s infinite;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="h-screen flex flex-col justify-center items-center bg-white">
        <img src="https://i.postimg.cc/4dNYygZr/Smart-Route-Logo.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <span class="loader"></span>
        <p class="mt-4 text-lg font-medium text-[var(--text-secondary)]">Verificando permissões...</p>
    </div>

    <div id="auth-message-screen" class="hidden h-screen flex flex-col justify-center items-center bg-white p-4 text-center">
        <img src="https://i.postimg.cc/4dNYygZr/Smart-Route-Logo.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <p id="auth-message-text" class="text-lg font-medium text-[var(--text-secondary)]"></p>
    </div>

    <div id="admin-app-container" class="hidden h-screen w-screen">
        <div id="admin-desktop-layout" class="hidden lg:flex h-full">
            <div class="w-72 bg-white shadow-md h-full flex-shrink-0 p-6 flex flex-col">
                <img src="https://i.postimg.cc/FKmK74Nh/Smart-Route-Horizontal.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
                <nav id="admin-desktop-nav" class="flex-grow space-y-2"></nav>
                <button id="logout-button-desktop" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair da Conta</span>
                </button>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm z-20 border-b border-[var(--border-color)] h-20 flex-shrink-0">
                    <h1 id="header-title-desktop" class="text-xl font-bold">Painel Admin</h1>
                    <div class="flex items-center gap-4">
                        <button id="panic-alert-icon-desktop" class="hidden p-2 rounded-full hover:bg-red-100">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </button>
                        <div id="desktop-user-info" class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100"></div>
                    </div>
                </header>
                <main id="main-content-desktop" class="p-8 flex-1 overflow-y-auto"></main>
            </div>
        </div>

        <div id="admin-mobile-layout" class="lg:hidden h-full">
            <div id="app-shell" class="max-w-lg mx-auto bg-[var(--light-bg)] h-full shadow-2xl relative flex flex-col">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm z-10 h-16 flex-shrink-0">
                    <button id="panic-alert-icon-mobile" class="hidden p-2">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </button>
                    <h1 id="header-title-mobile" class="text-xl font-bold">Painel Admin</h1>
                    <div class="relative">
                        <button id="profile-menu-button-mobile" class="p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <div id="profile-menu-mobile" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border">
                            <a href="#" id="view-profile-button-mobile" class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">Meu Perfil</a>
                            <div class="border-t"></div>
                            <a href="#" id="logout-button-mobile" class="block px-4 py-3 text-sm text-red-600 hover:bg-red-50">Sair da Conta</a>
                        </div>
                    </div>
                </header>

            <main id="main-content-mobile" class="flex-1 overflow-y-auto p-5 pb-32"></main>
            <nav id="bottom-nav" class="fixed bottom-0 w-full max-w-lg left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm border-t border-[var(--border-color)] grid grid-cols-5 text-center text-[var(--text-secondary)]"></nav>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white text-[var(--text-primary)] rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-[var(--light-bg)]"></div>
        </div>
    </div>

    <div id="panic-alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[100] flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col border-4 border-[var(--danger-red)]">
            <div class="p-5 bg-[var(--danger-red-light)] rounded-t-xl">
                <h3 class="text-2xl font-extrabold text-[var(--danger-red)] text-center">ALERTA DE PÂNICO RECEBIDO!</h3>
            </div>
            <div id="panic-alert-body" class="p-6 space-y-4"></div>
            <div class="p-4 bg-gray-50 rounded-b-xl">
                <button id="panic-modal-acknowledge-btn" class="w-full bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg text-lg">Confirmar Recebimento</button>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg z-[100]">
        <p id="toast-message"></p>
    </div>
    <div id="screen-templates" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, getDocs, setDoc, updateDoc, deleteDoc, where, orderBy, onSnapshot, limit, startAfter, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAqBwCgVJR_fH_QisTQZiIJE9B-2JC93vk",
            authDomain: "sunperyo.firebaseapp.com",
            projectId: "sunperyo",
            storageBucket: "sunperyo.appspot.com",
            messagingSenderId: "850650155716",
            appId: "1:850650155716:web:8bfb4799d92d701e421791"
        };
        const appId = "sunperyo-app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // VARIÁVEIS GLOBAIS
        let userData, allUsers = [], patrols = [], checkpoints = [], sites = [], mapInstance, screens = {}, modalStack = [], reportChart;
        let uiInitialized = false;
        let panicAlertsListener = null;
        let audioCtx = null;
        
        const mainContentDesktop = document.getElementById('main-content-desktop');
        const mainContentMobile = document.getElementById('main-content-mobile');
        const headerTitleDesktop = document.getElementById('header-title-desktop');
        const headerTitleMobile = document.getElementById('header-title-mobile');
        const modalOverlay = document.getElementById('modal-overlay');

        // FUNÇÃO DE INICIALIZAÇÃO
        async function startAdminApp(user, data) {
            userData = { id: user.uid, ...data };
            
            initializeTemplates();
            
            // Carregando todos os dados necessários em tempo real
            await loadSites();
            await loadPatrols();
            await loadCheckpoints();
            await loadUsers();
            listenForPanicAlerts();
            listenForLiveGuards(); 
            
            setupUI();
            handleNavigation(null, 'adminDashboard', 'Painel');
        }

        // Carrega as usinas em tempo real
        function loadSites() {
            const q = query(collection(db, `artifacts/${appId}/public/data/sites`), orderBy("name"));
            onSnapshot(q, (querySnapshot) => {
                sites = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                
                // Se a tela de usinas estiver aberta, atualiza a lista
                const sitesScreen = document.getElementById('admin-sites-screen');
                if (sitesScreen && sitesScreen.parentElement.id !== 'screen-templates') {
                    renderSitesScreen();
                }
            });
        }

        // Renderiza a tela de Usinas
        function renderSitesScreen() {
            const screen = screens.adminSites;
            screen.innerHTML = `<div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg">Gerenciar Usinas</h3>
                    <button id="add-site-btn" class="bg-[var(--primary-blue)] text-white font-bold px-4 py-2 rounded-lg hover:bg-[var(--accent-blue)] text-sm">Nova Usina</button>
                </div>
                <div id="sites-list" class="space-y-3"></div>`;
            const listDiv = screen.querySelector('#sites-list');
            
            if (sites.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhuma usina cadastrada.</p>';
            } else {
                 listDiv.innerHTML = sites.map(site => `
                    <div class="bg-white p-4 rounded-xl flex justify-between items-center border border-[var(--border-color)]">
                        <div class="flex items-center gap-4 overflow-hidden">
                             <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m5-4h1m-1 4h1m-1-8h1m-5 8h1m-1-4h1"></path></svg>
                            </div>
                            <p class="font-semibold text-[var(--text-primary)] truncate">${site.name}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button data-action="edit-site" data-id="${site.id}" data-name="${site.name}" class="p-2 text-blue-500 hover:bg-blue-100 rounded-full flex-shrink-0" title="Editar Nome">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.246l-4 1a1 1 0 01-1.255-1.255l1-4a1 1 0 01.246-.39l7.293-7.293zM14 7l2-2m-4 12v1a1 1 0 01-1 1H6a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v2z" /></svg>
                            </button>
                            <button data-action="delete-site" data-id="${site.id}" data-name="${site.name}" class="p-2 text-red-500 hover:bg-red-100 rounded-full flex-shrink-0" title="Excluir Usina">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            screen.querySelector('#add-site-btn').addEventListener('click', () => openSiteModal());

            listDiv.addEventListener('click', async (e) => {
                const target = e.target.closest('[data-action]');
                if(!target) return;

                const { action, id, name } = target.dataset;

                if (action === 'edit-site') {
                    openSiteModal({ id, name });
                }
                if (action === 'delete-site') {
                    if (!confirm(`Tem certeza que deseja excluir a usina "${name}"?\n\nTODOS os roteiros e vigilantes associados a ela serão desvinculados.`)) {
                        return;
                    }
                    
                    showToast("Excluindo e desvinculando...");
                    try {
                        // Desvincular roteiros
                        const affectedPatrols = patrols.filter(p => p.siteId === id);
                        const patrolPromises = affectedPatrols.map(p => {
                            const patrolRef = doc(db, `artifacts/${appId}/public/data/patrols`, p.id);
                            return updateDoc(patrolRef, { siteId: null });
                        });
                        await Promise.all(patrolPromises);

                        // Desvincular usuários
                        const affectedUsers = allUsers.filter(u => (u.assignedSiteIds || []).includes(id));
                        const userPromises = affectedUsers.map(u => {
                            const userRef = doc(db, "users", u.id);
                            return updateDoc(userRef, { assignedSiteIds: arrayRemove(id) });
                        });
                        await Promise.all(userPromises);

                        // Excluir a usina
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/sites`, id));
                        showToast("Usina excluída com sucesso!");

                    } catch (err) {
                        console.error("Erro ao excluir usina:", err);
                        showToast("Erro ao excluir usina.", true);
                    }
                }
            });
        }
        
        // Modal para criar/editar usina
        function openSiteModal(siteToEdit = null) {
            const isEditing = !!siteToEdit;
            const modalTitle = isEditing ? 'Editar Usina' : 'Nova Usina';
            
            openModal(modalTitle, `
                <div>
                    <label class="text-sm font-medium text-[var(--text-secondary)]">Nome da Usina</label>
                    <input id="site-name-input" type="text" placeholder="Ex: Usina Solar de Itajubá" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm border border-[var(--border-color)]" value="${isEditing ? siteToEdit.name : ''}">
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button id="save-site-btn" class="px-4 py-2 rounded-lg bg-[var(--primary-blue)] text-white hover:bg-[var(--accent-blue)]">Salvar</button>
                </div>
            `);

            document.getElementById('save-site-btn').addEventListener('click', async () => {
                const name = document.getElementById('site-name-input').value.trim();
                if (!name) return showToast("O nome da usina é obrigatório.", true);

                if (isEditing) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/sites`, siteToEdit.id), { name });
                    showToast("Usina atualizada!");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/sites`), { name });
                    showToast("Usina criada!");
                }
                closeModal();
            });
        }

        // Modal para associar um vigilante a usinas
        function openUserSiteAssignmentModal(userId, userName, currentAssignedIds = []) {
            const modalTitle = `Associar Usinas para ${userName}`;
            
            if (sites.length === 0) {
                 openModal(modalTitle, `<p class="text-center">Nenhuma usina cadastrada. Por favor, cadastre uma usina primeiro na aba "Usinas".</p>`);
                 return;
            }

            const sitesHtml = sites.map(site => `
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg hover:bg-gray-50 border cursor-pointer">
                    <input type="checkbox" value="${site.id}" class="h-5 w-5 rounded text-[var(--accent-blue)] focus:ring-[var(--accent-blue)]" ${currentAssignedIds.includes(site.id) ? 'checked' : ''}>
                    <p class="font-medium text-sm">${site.name}</p>
                </label>
            `).join('');

            openModal(modalTitle, `
                <div class="space-y-2" id="user-sites-checklist">${sitesHtml}</div>
                 <div class="mt-6 flex justify-end gap-3">
                    <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button id="save-user-sites-btn" class="px-4 py-2 rounded-lg bg-[var(--primary-blue)] text-white hover:bg-[var(--accent-blue)]">Salvar Associações</button>
                </div>
            `);

            document.getElementById('save-user-sites-btn').addEventListener('click', async () => {
                const selectedSiteIds = Array.from(document.querySelectorAll('#user-sites-checklist input:checked')).map(cb => cb.value);
                
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, { assignedSiteIds: selectedSiteIds });
                
                showToast("Associações do vigilante salvas!");
                closeModal();
            });
        }

        // --- MODIFICAÇÕES NAS FUNÇÕES EXISTENTES ---

        // Modificado: Adicionado dropdown de usina
        function openPatrolModal(patrolToEdit = null) {
            const isEditing = !!patrolToEdit;
            const modalTitle = isEditing ? 'Editar Roteiro de Ronda' : 'Novo Roteiro de Ronda';
        
            const checkpointsByCategory = checkpoints.reduce((acc, c) => {
                const category = c.category || 'Não categorizado';
                if (!acc[category]) acc[category] = [];
                acc[category].push(c);
                return acc;
            }, {});
        
            let checkpointGroupsHtml = '';
            if (Object.keys(checkpointsByCategory).length > 0) {
                 for (const category in checkpointsByCategory) {
                    const safeCategoryName = category.replace(/\s+/g, '-');
                    const checkpointsInGroup = checkpointsByCategory[category].map(c => {
                        const isChecked = isEditing && patrolToEdit.checkpoints.some(pc => pc.qrContent === c.qrContent);
                        return `
                            <label class="flex items-center gap-3 bg-white p-3 rounded-lg hover:bg-gray-50 border cursor-pointer">
                                <input type="checkbox" data-name="${c.name}" data-qr="${c.qrContent}" class="h-5 w-5 rounded text-[var(--accent-blue)] focus:ring-[var(--accent-blue)]" ${isChecked ? 'checked' : ''}>
                                <div>
                                    <p class="font-medium text-sm">${c.name}</p>
                                    <p class="text-xs text-gray-500">QR: ${c.qrContent}</p>
                                </div>
                            </label>
                        `;
                    }).join('');
        
                    checkpointGroupsHtml += `
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <button class="w-full flex justify-between items-center font-semibold text-left" data-action="toggle-checkpoint-group" data-target="${safeCategoryName}-group">
                                <span>${category} (${checkpointsByCategory[category].length})</span>
                                <svg class="w-5 h-5 transform transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="${safeCategoryName}-group" class="mt-2 space-y-2 hidden">
                                ${checkpointsInGroup}
                            </div>
                        </div>
                    `;
                }
            } else {
                checkpointGroupsHtml = '<p class="text-center text-sm text-gray-500 p-4 bg-gray-100 rounded-lg">Crie um Ponto na tela "Pontos (QR Codes)" primeiro.</p>';
            }
        
            openModal(modalTitle, `
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Nome do Roteiro</label>
                        <input id="patrol-name-input" type="text" placeholder="Ex: Ronda Noturna Bloco A" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm border border-[var(--border-color)]" value="${isEditing ? patrolToEdit.name : ''}">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Tempo Limite (minutos)</label>
                        <input id="patrol-time-limit-input" type="number" placeholder="Ex: 60" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm border border-[var(--border-color)]" value="${isEditing ? (patrolToEdit.timeLimitMinutes || '') : ''}">
                    </div>
                    
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Associar à Usina</label>
                        <select id="patrol-site-select" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm border border-[var(--border-color)]">
                            <option value="">-- Nenhuma / Geral --</option>
                            ${sites.map(s => `<option value="${s.id}" ${isEditing && patrolToEdit.siteId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Selecione os Pontos</label>
                        <div id="checkpoints-list-modal" class="mt-2 space-y-2 max-h-48 overflow-y-auto p-1">${checkpointGroupsHtml}</div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button id="save-patrol-btn" data-patrol-id="${isEditing ? patrolToEdit.id : ''}" class="px-4 py-2 rounded-lg bg-[var(--primary-blue)] text-white hover:bg-[var(--accent-blue)]">Salvar Roteiro</button>
                </div>`);
        
             document.getElementById('checkpoints-list-modal').addEventListener('click', (e) => {
                const target = e.target.closest('[data-action="toggle-checkpoint-group"]');
                if (target) {
                    const targetId = target.dataset.target;
                    const content = document.getElementById(targetId);
                    const icon = target.querySelector('svg');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                }
            });
        }

        // Modificado: Lógica de salvar roteiro agora inclui 'siteId'
        function handleModalAction(e) {
            const target = e.target.closest('[data-action], button');
            if (!target) return;
            
            const action = target.dataset.action;
            const targetId = target.id;

            if (action === 'close-modal' || targetId === 'modal-close-button') closeModal();

            if (targetId === 'loc-choice-gps') {
                const { checkpointId, checkpointName } = modalStack[modalStack.length - 1].context;
                openAddLocationHereModal(checkpointId, checkpointName);
                return;
            }
            if (targetId === 'loc-choice-map') {
                const { checkpointId, checkpointName, currentLoc } = modalStack[modalStack.length - 1].context;
                openAddLocationRemoteModal(checkpointId, checkpointName, currentLoc);
                return;
            }

            if (targetId === 'confirm-edit-btn') {
                updateDoc(doc(db, "users", target.dataset.userid), { role: target.dataset.newrole }).then(() => {
                    showToast("Função atualizada!");
                    closeModal();
                }).catch(() => showToast("Erro.", true));
            }
            if (targetId === 'confirm-delete-btn') {
                deleteDoc(doc(db, "users", target.dataset.userid)).then(() => {
                    showToast("Usuário excluído!");
                    closeModal();
                }).catch(() => showToast("Erro.", true));
            }
            if (targetId === 'save-patrol-btn') {
                const patrolName = document.getElementById('patrol-name-input').value.trim();
                const timeLimit = parseInt(document.getElementById('patrol-time-limit-input').value);
                const siteId = document.getElementById('patrol-site-select').value; // Pega o ID da usina
                const patrolId = target.dataset.patrolId;
                
                if (!patrolName) return showToast("O nome do roteiro é obrigatório.", true);
                if (isNaN(timeLimit) || timeLimit <= 0) return showToast("Insira um tempo limite válido em minutos.", true);

                const selectedCheckpoints = Array.from(document.querySelectorAll('#checkpoints-list-modal input:checked')).map(cb => ({ name: cb.dataset.name, qrContent: cb.dataset.qr }));
                if (selectedCheckpoints.length === 0) return showToast("Selecione pelo menos um ponto.", true);
                
                target.disabled = true;
                target.textContent = 'Salvando...';

                const docRef = patrolId ? doc(db, `artifacts/${appId}/public/data/patrols`, patrolId) : collection(db, `artifacts/${appId}/public/data/patrols`);
                const saveFunction = patrolId ? updateDoc : addDoc;

                // Adiciona siteId ao objeto salvo
                const patrolData = { 
                    name: patrolName, 
                    checkpoints: selectedCheckpoints, 
                    timeLimitMinutes: timeLimit,
                    siteId: siteId || null // Salva null se nenhuma usina for selecionada
                };

                saveFunction(docRef, patrolData)
                    .then(() => {
                        showToast("Roteiro salvo!");
                        closeModal();
                    }).catch(() => showToast("Erro ao salvar.", true)).finally(() => {
                        target.disabled = false;
                        target.textContent = 'Salvar Roteiro';
                    });
            }
            if (targetId === 'save-checkpoint-btn') {
                const name = document.getElementById('checkpoint-name-input').value;
                const qrContent = document.getElementById('checkpoint-qr-input').value;
                let category = document.getElementById('checkpoint-category-select').value;
                if (category === 'new-category') {
                    category = document.getElementById('new-category-input').value.trim();
                }

                if (!name || !qrContent) return showToast("Preencha todos os campos.", true);
                
                addDoc(collection(db, `artifacts/${appId}/public/data/checkpoints`), { name, qrContent, category }).then(() => {
                    showToast("Ponto salvo!");
                    closeModal();
                    setTimeout(() => displayGeneratedQRCode(name, qrContent), 350);
                }).catch(() => showToast("Erro.", true));
            }
        }

        // Modificado: Adiciona opção para gerenciar usinas e mostra usinas associadas
        function renderUsersList(users) {
            const usersListDiv = document.getElementById('users-list');
            if (!usersListDiv) return;
            usersListDiv.innerHTML = users.length === 0 ? '<p class="text-gray-500 text-center mt-8">Nenhum usuário encontrado.</p>' : users.map(user => {
                // Lógica para encontrar os nomes das usinas a partir dos IDs
                const userSites = (user.assignedSiteIds || [])
                    .map(siteId => {
                        const site = sites.find(s => s.id === siteId);
                        return site ? site.name : 'ID inválido';
                    })
                    .join(', ');

                return `
                <div class="bg-white p-4 rounded-xl flex justify-between items-center border border-[var(--border-color)] relative">
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-xl flex-shrink-0">
                            ${(user.name || 'U').charAt(0)}
                        </div>
                        <div class="overflow-hidden">
                            <p class="font-semibold text-[var(--text-primary)] truncate">${user.name || 'Nome não definido'}</p>
                            <p class="text-sm text-[var(--text-secondary)] truncate">${user.email}</p>
                            <p class="text-xs text-purple-700 font-semibold truncate mt-1" title="${userSites}">${userSites || 'Nenhuma usina associada'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs font-bold uppercase px-2 py-1 rounded-full ${user.role === 'admin' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span>
                        <button class="p-2 text-gray-500 hover:text-[var(--primary-blue)]" data-action="open-menu" data-userid="${user.id}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                    </div>
                    <div id="menu-${user.id}" class="hidden absolute right-4 top-14 bg-white shadow-lg rounded-lg border border-gray-200 z-10 w-48">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="view-rounds" data-userid="${user.id}" data-username="${user.name}">Ver Rondas</a>
                        ${user.role === 'guard' ? `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="manage-sites" data-userid="${user.id}" data-username="${user.name}">Gerenciar Usinas</a>` : ''}
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="edit-role" data-userid="${user.id}" data-username="${user.name}" data-currentrole="${user.role}">Editar Função</a>
                        <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50" data-action="delete-user" data-userid="${user.id}" data-username="${user.name}">Excluir Usuário</a>
                    </div>
                </div>`
            }).join('');
            usersListDiv.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', handleUserAction));
        }

        // Modificado: Adicionado o case para 'manage-sites'
        function handleUserAction(e) {
            e.stopPropagation();
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const userId = target.dataset.userid;
            const userName = target.dataset.username;
            document.querySelectorAll('[id^=menu-]').forEach(menu => { if (menu.id !== `menu-${userId}`) menu.classList.add('hidden'); });
            
            if (action === 'open-menu') document.getElementById(`menu-${userId}`).classList.toggle('hidden');
            if (action === 'view-rounds') openModal(`Rondas de ${userName}`, null, { renderer: (c) => showPatrolsForUser(userId, c) });
            
            // NOVO CASE PARA GERENCIAR USINAS
            if (action === 'manage-sites') {
                const user = allUsers.find(u => u.id === userId);
                openUserSiteAssignmentModal(userId, userName, user.assignedSiteIds || []);
            }
            
            if (action === 'edit-role') {
                const newRole = target.dataset.currentrole === 'admin' ? 'guard' : 'admin';
                openModal('Editar Função', `<p>Mudar a função de <strong>${userName}</strong> para <strong>${newRole.toUpperCase()}</strong>?</p>
                    <div class="mt-6 flex justify-end gap-3"><button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button><button id="confirm-edit-btn" data-userid="${userId}" data-newrole="${newRole}" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Confirmar</button></div>`);
            }
            if (action === 'delete-user') {
                 openModal('Excluir Usuário', `<p>Tem certeza que deseja excluir <strong>${userName}</strong>?</p>
                    <div class="mt-6 flex justify-end gap-3"><button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button><button id="confirm-delete-btn" data-userid="${userId}" class="px-4 py-2 rounded-lg bg-red-600 text-white">Excluir</button></div>`);
            }
        }

        // Modificado: Adicionada a nova tela de Usinas
        function updateNavigation() {
            const navItems = `
                <a href="#" data-nav="adminDashboard" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Painel</span>
                </a>
                <a href="#" data-nav="adminSites" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m5-4h1m-1 4h1m-1-8h1m-5 8h1m-1-4h1"></path></svg>
                    <span>Usinas</span>
                </a>
                <a href="#" data-nav="adminPatrols" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13V7m0 13l6-3l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 6l6-3"></path></svg>
                    <span>Roteiros</span>
                </a>
                <a href="#" data-nav="adminCheckpoints" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>
                    <span>Pontos (QR Codes)</span>
                </a>
                <a href="#" data-nav="adminReports" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Relatórios</span>
                </a>
                <a href="#" data-nav="adminAlerts" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0m-12.728 0l12.728 12.728"></path></svg>
                    <span>Alertas</span>
                </a>
            `;
            document.getElementById('admin-desktop-nav').innerHTML = navItems;
            
            const bottomNavEl = document.getElementById('bottom-nav');
            // Reordenando para 5 itens, Usinas entra no lugar de Alertas que sai da barra inferior.
            const bottomNavItems = `
                <button data-nav="adminDashboard" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="text-xs mt-1 block">Painel</span>
                </button>
                 <button data-nav="adminSites" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m5-4h1m-1 4h1m-1-8h1m-5 8h1m-1-4h1"></path></svg>
                    <span class="text-xs mt-1 block">Usinas</span>
                </button>
                <button data-nav="adminPatrols" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13V7m0 13l6-3l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 6l6-3"></path></svg>
                    <span class="text-xs mt-1 block">Roteiros</span>
                </button>
                <button data-nav="adminCheckpoints" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>
                    <span class="text-xs mt-1 block">Pontos</span>
                </button>
                <button data-nav="adminReports" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="text-xs mt-1 block">Relatórios</span>
                </button>
            `;
            bottomNavEl.innerHTML = bottomNavItems;
        }

        // Modificado: Adicionado o case para a nova tela de Usinas
        function handleNavigation(e, navTarget, navTitle) {
            if(e) e.preventDefault();
            
            const targetEl = e ? e.target.closest('[data-nav]') : null;
            if (!targetEl && !navTarget) return;

            const screenName = navTarget || targetEl.dataset.nav;
            const title = navTitle || targetEl.querySelector('span').textContent;

            if (!screenName) return;

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll(`[data-nav=${screenName}]`).forEach(item => item.classList.add('active'));
            
            const screenMap = {
                profile: { load: loadProfile },
                adminDashboard: { load: loadAdminDashboard },
                adminSites: { load: renderSitesScreen }, // NOVO
                adminPatrols: { load: renderPatrols },
                adminCheckpoints: { load: renderCheckpoints },
                adminReports: { load: loadReportsDashboard },
                adminAlerts: { load: loadAlertsScreen },
            };
            
            navigateToScreen(screenName, title);
            if (screenMap[screenName]?.load) {
                screenMap[screenName].load();
            }
        }
        
        function initializeTemplates() {
            const templateContainer = document.getElementById('screen-templates');
            templateContainer.innerHTML = `
                <div id="admin-dashboard-screen"></div>
                <div id="admin-sites-screen"></div>
                <div id="admin-patrols-screen"></div>
                <div id="admin-checkpoints-screen"></div>
                <div id="admin-reports-screen"></div>
                <div id="admin-alerts-screen"></div>
                <div id="profile-screen"></div>
            `;
            screens = {
                adminDashboard: document.getElementById('admin-dashboard-screen'),
                adminSites: document.getElementById('admin-sites-screen'),
                adminPatrols: document.getElementById('admin-patrols-screen'),
                adminCheckpoints: document.getElementById('admin-checkpoints-screen'),
                adminReports: document.getElementById('admin-reports-screen'),
                adminAlerts: document.getElementById('admin-alerts-screen'),
                profile: document.getElementById('profile-screen'),
            };
        }

        function setupUI() {
            const isDesktop = window.innerWidth >= 1024;
            document.getElementById('admin-desktop-layout').classList.toggle('hidden', !isDesktop);
            document.getElementById('admin-mobile-layout').classList.toggle('hidden', isDesktop);
            
            if (!uiInitialized) {
                updateNavigation();
                
                document.getElementById('admin-desktop-nav').addEventListener('click', handleNavigation);
                document.getElementById('bottom-nav').addEventListener('click', handleNavigation);
                document.getElementById('logout-button-desktop').addEventListener('click', () => signOut(auth));
                document.getElementById('logout-button-mobile').addEventListener('click', () => signOut(auth));
                document.getElementById('modal-close-button').addEventListener('click', () => closeModal(true));
                document.getElementById('modal-body').addEventListener('click', handleModalAction);
                
                const profileMenuButton = document.getElementById('profile-menu-button-mobile');
                const profileMenu = document.getElementById('profile-menu-mobile');
                profileMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileMenu.classList.toggle('hidden');
                });
                document.getElementById('view-profile-button-mobile').addEventListener('click', () => {
                    profileMenu.classList.add('hidden');
                    openModal('Meu Perfil', null, { renderer: (c) => loadProfile(c) });
                });
                document.getElementById('desktop-user-info').addEventListener('click', () => openModal('Meu Perfil', null, { renderer: (c) => loadProfile(c) }));
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#profile-menu-button-mobile')) {
                        profileMenu.classList.add('hidden');
                    }
                    if (!e.target.closest('[data-action="open-menu"]') && !e.target.closest('[id^=menu-]')) {
                        document.querySelectorAll('[id^=menu-]').forEach(menu => menu.classList.add('hidden'));
                    }
                });
                
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(true); });
                window.addEventListener('resize', setupUI);
                uiInitialized = true;
            }
            updateUserInfo();
        }

        function updateUserInfo() {
             const userInfoHtml = `
                <div class="text-right overflow-hidden">
                    <p class="font-semibold truncate">${userData.name}</p>
                    <p class="text-sm text-gray-500 truncate">${userData.email}</p>
                </div>
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-xl flex-shrink-0">
                    ${(userData.name || 'U').charAt(0)}
                </div>`;
            document.getElementById('desktop-user-info').innerHTML = `<div class="flex items-center gap-3">${userInfoHtml}</div>`;
        }

        function navigateToScreen(screenName, title) {
            const isDesktop = window.innerWidth >= 1024;
            const mainContent = isDesktop ? mainContentDesktop : mainContentMobile;
            const templateContainer = document.getElementById('screen-templates');

            if (mainContent.firstChild) {
                templateContainer.appendChild(mainContent.firstChild);
            }

            if (screens[screenName]) {
                mainContent.appendChild(screens[screenName]);
                headerTitleDesktop.textContent = title;
                headerTitleMobile.textContent = title;
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-lg z-[100] ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function openModal(title, contentHtml, state = {}) {
            state.title = title;
            state.contentHtml = contentHtml;
            if (state.onOpen) state.onOpen();
            modalStack.push(state);
            renderCurrentModal();
        }

        function renderCurrentModal() {
            if (modalStack.length === 0) {
                modalOverlay.classList.add('hidden');
                return;
            }
            const currentState = modalStack[modalStack.length - 1];
            document.getElementById('modal-title').textContent = currentState.title;
            const modalBody = document.getElementById('modal-body');

            if (currentState.renderer) {
                currentState.renderer(modalBody);
            } else {
                modalBody.innerHTML = currentState.contentHtml;
            }

            modalOverlay.classList.remove('hidden');
        }

        function closeModal(forceAll = false) {
            if (forceAll) {
                modalStack.forEach(state => {
                    if (state.onClose) state.onClose();
                });
                modalStack = [];
            } else if (modalStack.length > 0) {
                const closingState = modalStack.pop();
                if (closingState.onClose) closingState.onClose();
            }
            renderCurrentModal();
        }

        function playAlertSound() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            
            oscillator.start();
            setTimeout(() => oscillator.stop(), 200);
        }

        function listenForPanicAlerts() {
            if (panicAlertsListener) panicAlertsListener();
            
            const q = query(collection(db, `artifacts/${appId}/public/data/panicAlerts`), orderBy("timestamp", "desc"), limit(1));

            panicAlertsListener = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const alertData = change.doc.data();
                        const alertId = change.doc.id;

                        const alreadyAcknowledged = userData.acknowledgedAlerts && userData.acknowledgedAlerts.includes(alertId);

                        if (!alreadyAcknowledged) {
                            showPanicAlertModal(alertData, alertId);
                        } else {
                            document.querySelectorAll('#panic-alert-icon-desktop, #panic-alert-icon-mobile').forEach(icon => {
                                icon.classList.remove('hidden', 'panic-alert-active');
                                icon.onclick = () => showPanicAlertModal(alertData, alertId);
                            });
                        }
                    }
                });
            });
        }

        function showPanicAlertModal(alertData, alertId) {
            playAlertSound();
            const intervalId = setInterval(playAlertSound, 1000);

            const modal = document.getElementById('panic-alert-modal');
            const body = document.getElementById('panic-alert-body');
            const time = safeTimestampToDate(alertData.timestamp).toLocaleString('pt-BR');

            body.innerHTML = `
                <p class="text-lg"><strong class="font-bold">Vigilante:</strong> ${alertData.userName}</p>
                <p class="text-lg"><strong class="font-bold">Horário:</strong> ${time}</p>
                <div id="panic-map" class="h-64 w-full bg-gray-200 rounded-lg mt-4"></div>
            `;
            modal.classList.remove('hidden');

            document.querySelectorAll('#panic-alert-icon-desktop, #panic-alert-icon-mobile').forEach(icon => {
                icon.classList.remove('hidden');
                icon.classList.add('panic-alert-active');
                icon.onclick = () => showPanicAlertModal(alertData, alertId);
            });

            setTimeout(() => {
                const map = L.map('panic-map').setView([alertData.location.latitude, alertData.location.longitude], 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([alertData.location.latitude, alertData.location.longitude]).addTo(map)
                    .bindPopup(`<b>${alertData.userName}</b><br>Local do Alerta`).openPopup();
            }, 150);

            document.getElementById('panic-modal-acknowledge-btn').onclick = async () => {
                clearInterval(intervalId);
                modal.classList.add('hidden');
                document.querySelectorAll('#panic-alert-icon-desktop, #panic-alert-icon-mobile').forEach(icon => {
                    icon.classList.remove('panic-alert-active');
                });

                try {
                    const userRef = doc(db, "users", userData.id);
                    await updateDoc(userRef, {
                        acknowledgedAlerts: arrayUnion(alertId)
                    });
                    if (!userData.acknowledgedAlerts) userData.acknowledgedAlerts = [];
                    userData.acknowledgedAlerts.push(alertId);
                } catch (error) {
                    console.error("Erro ao salvar reconhecimento do alerta:", error);
                    showToast("Erro ao confirmar o alerta. Tente novamente.", true);
                }
            };
        }

        function listenForLiveGuards() {
            const q = query(collection(db, `artifacts/${appId}/public/data/liveGuards`));
            onSnapshot(q, (snapshot) => {
                const activeGuards = [];
                const now = new Date().getTime();
                const STALE_THRESHOLD_MS = 5 * 60 * 1000; 
                snapshot.forEach((doc) => {
                    const guardData = doc.data();
                    
                    if (guardData.status === 'on-patrol') {
                        const lastUpdate = safeTimestampToDate(guardData.lastUpdate).getTime();
                        const age = now - lastUpdate;
                        if (age < STALE_THRESHOLD_MS) {
                            activeGuards.push(guardData);
                        }
                    }
                });
                renderActiveGuardsList(activeGuards);
            });
        }

        function renderActiveGuardsList(activeGuards) {
            const listContainer = document.getElementById('active-guards-list');
            if (!listContainer) return;

            if (activeGuards.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum vigilante em ronda no momento.</p>';
                return;
            }

            listContainer.innerHTML = activeGuards.map(guard => `
                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center border hover:bg-gray-100 cursor-pointer" data-guard-id="${guard.userId}">
                    <div>
                        <p class="font-semibold text-sm text-[var(--text-primary)]">${guard.userName}</p>
                        <p class="text-xs text-gray-500">Ronda: ${guard.patrolName || 'N/A'}</p>
                        <p class="text-xs text-gray-500">Última att: ${safeTimestampToDate(guard.lastUpdate).toLocaleTimeString('pt-BR')}</p>
                    </div>
                    <button class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-md hover:bg-blue-700">Ver no Mapa</button>
                </div>
            `).join('');

            listContainer.querySelectorAll('[data-guard-id]').forEach(el => {
                el.addEventListener('click', () => {
                    const guardId = el.dataset.guardId;
                    const guardData = activeGuards.find(g => g.userId === guardId);
                    if (guardData) {
                        showLiveGuardMapModal(guardData);
                    }
                });
            });
        }
        
        function showLiveGuardMapModal(guardData) {
            const modalHtml = `
                <div id="live-guard-map" class="h-80 w-full bg-gray-200 rounded-lg z-0 mb-4"></div>
                <div class="text-center">
                    <p class="font-bold">${guardData.userName}</p>
                    <p class="text-sm text-gray-600">Ronda: ${guardData.patrolName}</p>
                    <p class="text-xs text-gray-500">Atualizado às: ${safeTimestampToDate(guardData.lastUpdate).toLocaleString('pt-BR')}</p>
                </div>
            `;
            openModal(`Localização de ${guardData.userName.split(' ')[0]}`, modalHtml);

            setTimeout(() => {
                const mapEl = document.getElementById('live-guard-map');
                if (mapEl) {
                    const latLng = [guardData.location.latitude, guardData.location.longitude];
                    const map = L.map(mapEl).setView(latLng, 17);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    L.marker(latLng).addTo(map)
                        .bindPopup(`<b>${guardData.userName}</b><br>Localização atual`).openPopup();
                }
            }, 150);
        }

        async function fetchAndRenderPanicAlerts() {
            const container = document.getElementById('panic-alerts-history');
            if (!container) return;
            
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/panicAlerts`), orderBy("timestamp", "desc"), limit(10));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-sm text-gray-500 py-4">Nenhum alerta de pânico recente.</p>';
                    return;
                }

                const alerts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                container.innerHTML = alerts.map(alert => `
                    <div class="p-3 rounded-lg flex justify-between items-center transition-colors hover:bg-red-50 border border-red-200 cursor-pointer" data-alert-data='${JSON.stringify(alert)}'>
                        <div>
                            <p class="font-semibold text-sm text-red-700">${alert.userName}</p>
                            <p class="text-xs text-gray-500">${safeTimestampToDate(alert.timestamp).toLocaleString('pt-BR')}</p>
                        </div>
                        <span class="text-sm font-bold text-red-600">VER ALERTA</span>
                    </div>
                `).join('');

                container.querySelectorAll('[data-alert-data]').forEach(el => {
                    el.addEventListener('click', () => {
                        const alertData = JSON.parse(el.dataset.alertData);
                        showPanicAlertModal(alertData, alertData.id);
                    });
                });

            } catch (error) {
                console.error("Erro ao buscar alertas de pânico:", error);
                container.innerHTML = '<p class="text-center text-sm text-red-500 py-4">Erro ao carregar alertas.</p>';
            }
        }

        async function loadReportsDashboard() {
            const container = screens.adminReports;
            container.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                    <div class="flex-shrink-0 bg-white p-1 rounded-lg shadow-sm border flex gap-1">
                        <button class="report-tab px-4 py-2 rounded-md text-sm font-semibold text-gray-600 transition-colors" data-tab="dashboard">Dashboard</button>
                        <button class="report-tab px-4 py-2 rounded-md text-sm font-semibold text-gray-600 transition-colors" data-tab="exceptions">Exceções</button>
                    </div>
                    <div id="date-filter-container" class="flex-shrink-0 bg-white p-1 rounded-lg shadow-sm border flex gap-1">
                        <button class="date-filter-btn px-3 py-1.5 rounded-md text-sm font-semibold text-gray-600 transition-colors" data-days="0">Hoje</button>
                        <button class="date-filter-btn px-3 py-1.5 rounded-md text-sm font-semibold text-gray-600 transition-colors" data-days="7">7 Dias</button>
                        <button class="date-filter-btn px-3 py-1.5 rounded-md text-sm font-semibold text-gray-600 transition-colors" data-days="30">30 Dias</button>
                    </div>
                </div>
                <div id="reports-content" class="space-y-6">
                    <div class="flex justify-center items-center p-12"><span class="loader"></span></div>
                </div>
            `;

            const dateFilterContainer = container.querySelector('#date-filter-container');
            const reportTabsContainer = container.querySelector('.flex-shrink-0');

            const updateView = () => {
                const activeTab = reportTabsContainer.querySelector('.report-tab.active').dataset.tab;
                const activeDays = parseInt(dateFilterContainer.querySelector('.date-filter-btn.active').dataset.days);
                if (activeTab === 'dashboard') {
                    updateReportsView(activeDays);
                } else {
                    updateExceptionReportsView(activeDays);
                }
            };
            
            dateFilterContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.date-filter-btn');
                if (btn) {
                    dateFilterContainer.querySelectorAll('.date-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateView();
                }
            });

            reportTabsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.report-tab');
                if (btn) {
                    reportTabsContainer.querySelectorAll('.report-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateView();
                }
            });

            reportTabsContainer.querySelector('[data-tab="dashboard"]').classList.add('active');
            dateFilterContainer.querySelector('[data-days="0"]').classList.add('active');
            updateReportsView(0);
        }

        async function fetchPatrolsForPeriod(days) {
            const endDate = new Date();
            const startDate = new Date();
            if (days > 0) {
                 startDate.setDate(startDate.getDate() - days);
            }
            startDate.setHours(0, 0, 0, 0);

            const guardUsers = allUsers.filter(u => u.role === 'guard');
            const patrolPromises = guardUsers.map(user => {
                const patrolsRef = collection(db, `artifacts/${appId}/users/${user.id}/completedPatrols`);
                const q = query(patrolsRef, where("endTime", ">=", startDate), where("endTime", "<=", endDate));
                return getDocs(q).then(snapshot => snapshot.docs.map(d => ({ 
                    ...d.data(), 
                    id: d.id,
                    userId: user.id, 
                    userName: user.name 
                })));
            });

            const allPatrolsNested = await Promise.all(patrolPromises);
            return allPatrolsNested.flat().sort((a, b) => safeTimestampToDate(b.endTime) - safeTimestampToDate(a.endTime));
        }

        async function updateExceptionReportsView(days) {
            const reportsContent = document.getElementById('reports-content');
            reportsContent.innerHTML = `<div class="flex justify-center items-center p-12"><span class="loader"></span></div>`;
            
            const allPatrols = await fetchPatrolsForPeriod(days);
            
            const latePatrols = [];
            const patrolsWithMissedPoints = [];
            const expiredPatrols = [];

            allPatrols.forEach(p => {
                const patrolTemplate = patrols.find(pt => pt.id === p.patrolId);
                
                if (p.status === 'expired') {
                    expiredPatrols.push(p);
                }

                if (p.status === 'completed' && patrolTemplate && patrolTemplate.timeLimitMinutes) {
                    const startTime = safeTimestampToDate(p.startTime).getTime();
                    const endTime = safeTimestampToDate(p.endTime).getTime();
                    const durationMinutes = (endTime - startTime) / 60000;
                    if (durationMinutes > patrolTemplate.timeLimitMinutes) {
                        p.exceededBy = Math.round(durationMinutes - patrolTemplate.timeLimitMinutes);
                        latePatrols.push(p);
                    }
                }

                if(p.requiredCheckpoints && p.scannedCheckpoints) {
                    const requiredCount = p.requiredCheckpoints.length;
                    const scannedCount = p.scannedCheckpoints.length;
                    if (requiredCount > scannedCount) {
                        const scannedSet = new Set(p.scannedCheckpoints);
                        p.missedPoints = p.requiredCheckpoints.filter(cp => !scannedSet.has(cp.qrContent));
                        patrolsWithMissedPoints.push(p);
                    }
                }
            });

            renderExceptionReportContent(latePatrols, patrolsWithMissedPoints, expiredPatrols);
            fetchAndRenderPanicAlerts();
        }

        function renderExceptionReportContent(latePatrols, patrolsWithMissedPoints, expiredPatrols) {
            const reportsContent = document.getElementById('reports-content');
            
            const createSummaryCard = (title, data, modalTitle, renderer) => {
                const count = data.length;
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-xl shadow-md border";
                card.innerHTML = `
                    <h4 class="font-bold mb-2 text-[var(--text-secondary)]">${title}</h4>
                    <p class="text-4xl font-extrabold text-[var(--primary-blue)]">${count}</p>
                    <p class="text-sm text-gray-500 mt-1">${count > 0 ? 'Clique para ver detalhes' : 'Nenhuma ocorrência'}</p>
                `;
                if (count > 0) {
                    card.classList.add('cursor-pointer', 'hover:bg-gray-50');
                    card.onclick = () => openModal(modalTitle, null, { renderer: (container) => renderer(container, data) });
                }
                return card;
            };

            const renderExpiredPatrolsModal = (container, patrols) => {
                container.innerHTML = patrols.map(p => `
                    <div class="p-3 rounded-lg flex justify-between items-center transition-colors hover:bg-gray-50 border-b">
                        <div>
                            <p class="font-semibold text-sm">${p.patrolName}</p>
                            <p class="text-xs text-gray-500">Por ${p.userName} em ${safeTimestampToDate(p.endTime).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <span class="text-sm font-bold text-red-600">Tempo Expirado</span>
                    </div>
                `).join('');
            };

            const renderMissedPointsModal = (container, patrols) => {
                 container.innerHTML = patrols.map(p => `
                    <div class="p-3 rounded-lg transition-colors hover:bg-gray-50 border-b">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-sm">${p.patrolName}</p>
                                <p class="text-xs text-gray-500">Por ${p.userName} em ${safeTimestampToDate(p.endTime).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <span class="text-sm font-bold text-orange-600">${p.missedPoints.length} ponto(s) perdido(s)</span>
                        </div>
                        <div class="pl-4 mt-2 text-xs text-gray-600">
                            ${p.missedPoints.map(mp => `<span>- ${mp.name}</span>`).join('<br>')}
                        </div>
                    </div>
                `).join('');
            };

            const renderLatePatrolsModal = (container, patrols) => {
                container.innerHTML = patrols.map(p => `
                    <div class="p-3 rounded-lg flex justify-between items-center transition-colors hover:bg-gray-50 border-b">
                        <div>
                            <p class="font-semibold text-sm">${p.patrolName}</p>
                            <p class="text-xs text-gray-500">Por ${p.userName} em ${safeTimestampToDate(p.endTime).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <span class="text-sm font-bold text-yellow-600">${p.exceededBy} min de atraso</span>
                    </div>
                `).join('');
            };
            
            reportsContent.innerHTML = `<div id="exception-cards-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>`;
            const container = reportsContent.querySelector('#exception-cards-container');

            container.appendChild(createSummaryCard('Rondas Expiradas', expiredPatrols, 'Detalhes de Rondas Expiradas', renderExpiredPatrolsModal));
            container.appendChild(createSummaryCard('Rondas com Pontos Perdidos', patrolsWithMissedPoints, 'Detalhes de Pontos Perdidos', renderMissedPointsModal));
            container.appendChild(createSummaryCard('Concluídas com Atraso', latePatrols, 'Detalhes de Rondas Atrasadas', renderLatePatrolsModal));
        }

        async function updateReportsView(days) {
            const reportsContent = document.getElementById('reports-content');
            reportsContent.innerHTML = `<div class="flex justify-center items-center p-12"><span class="loader"></span></div>`;
            const allPatrols = await fetchPatrolsForPeriod(days);
            renderReportContent(allPatrols, days);
            fetchAndRenderPanicAlerts(); 
        }

        function loadAdminDashboard() {
            const container = screens.adminDashboard;
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md border border-[var(--border-color)]">
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">Vigilantes</p>
                        <p id="admin-total-users" class="text-3xl font-extrabold text-[var(--primary-blue)]">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-[var(--border-color)]">
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">Rondas Finalizadas Hoje</p>
                        <p id="admin-rounds-today" class="text-3xl font-extrabold text-[var(--primary-blue)]">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-[var(--border-color)] mb-6">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg mb-2">Vigilantes em Ronda</h3>
                    <div id="active-guards-list" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">Nenhum vigilante em ronda no momento.</p>
                    </div>
                </div>
                <h3 class="font-bold mb-2 text-[var(--text-secondary)] text-lg">Gerenciar Vigilantes</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div class="relative">
                        <input id="search-user-input" type="text" placeholder="Buscar por nome ou email..." class="w-full pl-10 pr-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="relative">
                        <select id="site-filter-select" class="w-full px-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm appearance-none">
                            <option value="all">Todas as Usinas</option>
                            <option value="none">Não Associados</option>
                            ${sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                        <svg class="w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
                <div id="users-list" class="space-y-3"></div>`;
            
            // Função interna para aplicar os filtros e redesenhar a lista
            const applyFilters = () => {
                const searchTerm = container.querySelector('#search-user-input').value.toLowerCase();
                const siteFilter = container.querySelector('#site-filter-select').value;

                let filteredUsers = allUsers;

                // 1. Filtra por termo de busca (nome/email)
                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(user => 
                        user.email.toLowerCase().includes(searchTerm) || 
                        (user.name && user.name.toLowerCase().includes(searchTerm))
                    );
                }

                // 2. Filtra pela usina selecionada
                if (siteFilter === 'none') {
                    // Mostra apenas vigilantes sem usina associada
                    filteredUsers = filteredUsers.filter(user => !user.assignedSiteIds || user.assignedSiteIds.length === 0);
                } else if (siteFilter !== 'all') {
                    // Mostra vigilantes de uma usina específica
                    filteredUsers = filteredUsers.filter(user => user.assignedSiteIds && user.assignedSiteIds.includes(siteFilter));
                }
                
                // Renderiza a lista apenas com os vigilantes que passaram pelos filtros
                renderUsersList(filteredUsers.filter(u => u.role === 'guard'));
            };
            
            // Adiciona os "escutadores" de eventos aos campos de filtro
            container.querySelector('#search-user-input').addEventListener('input', applyFilters);
            container.querySelector('#site-filter-select').addEventListener('change', applyFilters);

            // Carrega as estatísticas e a lista inicial de usuários
            loadAdminStats();
            renderUsersList(allUsers.filter(u => u.role === 'guard'));
        }


        async function loadAdminStats() {
            const totalUsersEl = document.getElementById('admin-total-users');
            if(totalUsersEl) totalUsersEl.textContent = allUsers.filter(u => u.role === 'guard').length;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const guardUsers = allUsers.filter(u => u.role === 'guard');
            const promises = guardUsers.map(user => {
                const patrolsRef = collection(db, `artifacts/${appId}/users/${user.id}/completedPatrols`);
                
                const q = query(patrolsRef, 
                    where("endTime", ">=", today),
                    where("status", "==", "completed")
                );

                return getDocs(q).then(snapshot => snapshot.size);
            });

            const totalRoundsToday = (await Promise.all(promises)).reduce((sum, count) => sum + count, 0);
            
            const roundsTodayElAdmin = document.getElementById('admin-rounds-today');
            if(roundsTodayElAdmin) roundsTodayElAdmin.textContent = totalRoundsToday;
        }

        function loadUsers() {
            const q = query(collection(db, "users"));
            onSnapshot(q, (querySnapshot) => {
                allUsers = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                if (document.getElementById('admin-dashboard-screen')?.firstChild) {
                   loadAdminStats();
                }

                const usersListDiv = document.getElementById('users-list');
                if (usersListDiv) {
                    const searchTerm = document.getElementById('search-user-input')?.value.toLowerCase() || '';
                    const filteredUsers = allUsers.filter(user => 
                        user.email.toLowerCase().includes(searchTerm) || 
                        (user.name && user.name.toLowerCase().includes(searchTerm))
                    );
                    renderUsersList(filteredUsers);
                }
            });
        }
        
        function safeTimestampToDate(ts) {
            if (!ts) return new Date();
            if (typeof ts.toDate === 'function') return ts.toDate();
            if (ts.seconds) return new Date(ts.seconds * 1000);
            return new Date(ts);
        }

        async function showPatrolsForUser(userId, container) {
            container.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/completedPatrols`), orderBy("endTime", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ronda encontrada.</p>';
                    return;
                }
                
                const patrolsByDate = {};
                const patrolDocs = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));

                patrolDocs.forEach(patrol => {
                    const date = safeTimestampToDate(patrol.endTime).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!patrolsByDate[date]) patrolsByDate[date] = [];
                    patrolsByDate[date].push(patrol);
                });

                let datesHtml = '<div class="space-y-2">';
                for (const date in patrolsByDate) {
                    datesHtml += `<div class="bg-white p-4 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border border-[var(--border-color)]" data-date-key="${date}">
                           <p class="font-semibold text-[var(--text-primary)] flex justify-between items-center">${date} <span class="text-sm font-normal text-white bg-[var(--primary-blue)] px-2 py-0.5 rounded-full">${patrolsByDate[date].length}</span></p>
                        </div>`;
                }
                datesHtml += '</div>';
                container.innerHTML = datesHtml;
                container.querySelectorAll('[data-date-key]').forEach(el => {
                    el.addEventListener('click', () => {
                        const dateKey = el.dataset.dateKey;
                        openModal(`Rondas de ${dateKey}`, null, { renderer: (c) => showPatrolsForDate(c, dateKey, patrolsByDate[dateKey]) });
                    });
                });
            } catch (error) {
                console.error("Erro ao carregar rondas do usuário:", error);
                container.innerHTML = `<p class="text-center text-red-500">Erro ao carregar rondas.</p>`;
            }
        }

        function showPatrolsForDate(container, date, patrols) {
            let patrolsHtml = '<div class="space-y-2">';
            patrols.forEach((patrol, index) => {
                const startTime = safeTimestampToDate(patrol.startTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const endTime = safeTimestampToDate(patrol.endTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const eventCounts = patrol.events.reduce((acc, event) => { acc[event.type] = (acc[event.type] || 0) + 1; return acc; }, { qrScan: 0, photo: 0 });

                patrolsHtml += `<button class="w-full bg-white p-3 rounded-lg flex justify-between items-center border border-[var(--border-color)] text-left hover:bg-gray-50" data-patrol-index="${index}">
                        <div class="overflow-hidden">
                            <p class="font-bold text-[var(--text-primary)] truncate">${patrol.patrolName}</p>
                            <p class="text-sm text-[var(--text-secondary)]">Início: ${startTime} | Fim: ${endTime}</p>
                             <p class="text-sm text-[var(--text-secondary)]">Registros: ${eventCounts.qrScan} QR / ${eventCounts.photo} Fotos</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>`;
            });
            patrolsHtml += '</div>';
            container.innerHTML = patrolsHtml;
            container.querySelectorAll('[data-patrol-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const patrolData = patrols[parseInt(el.dataset.patrolIndex)];
                    openModal(`Detalhes: ${patrolData.patrolName}`, null, { renderer: (c) => showPatrolDetails(c, patrolData, date) });
                });
            });
        }
        
        function openPhotoGalleryModal(photos, startIndex) {
            let currentIndex = startIndex;
            const modalContent = document.getElementById('modal-content');
            const modalBody = document.getElementById('modal-body');

            const updateGalleryView = () => {
                const photo = photos[currentIndex];
                modalBody.innerHTML = `
                    <div class="relative">
                        <div class="bg-black flex justify-center items-center h-[75vh]">
                            <img src="${photo.photoBase64}" class="max-w-full max-h-full object-contain">
                        </div>
                        
                        <button id="gallery-prev-btn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-40 text-white rounded-full p-2 hover:bg-opacity-60 transition-opacity ${photos.length <= 1 ? 'hidden' : ''}">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>

                        <button id="gallery-next-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-40 text-white rounded-full p-2 hover:bg-opacity-60 transition-opacity ${photos.length <= 1 ? 'hidden' : ''}">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>

                        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white text-sm px-3 py-1 rounded-full">
                            ${currentIndex + 1} / ${photos.length}
                        </div>
                    </div>`;

                document.getElementById('gallery-prev-btn')?.addEventListener('click', () => {
                    currentIndex = (currentIndex - 1 + photos.length) % photos.length;
                    updateGalleryView();
                });

                document.getElementById('gallery-next-btn')?.addEventListener('click', () => {
                    currentIndex = (currentIndex + 1) % photos.length;
                    updateGalleryView();
                });
            };

            const setupStyles = () => {
                modalContent.classList.remove('max-w-md');
                modalContent.classList.add('max-w-4xl');
                modalBody.classList.remove('p-6', 'bg-[var(--light-bg)]');
                modalBody.classList.add('p-0');
            };

            const cleanupStyles = () => {
                modalContent.classList.add('max-w-md');
                modalContent.classList.remove('max-w-4xl');
                modalBody.classList.add('p-6', 'bg-[var(--light-bg)]');
                modalBody.classList.remove('p-0');
            };

            openModal(`Foto da Ronda`, null, {
                renderer: () => updateGalleryView(),
                onOpen: setupStyles,
                onClose: cleanupStyles,
            });
        }

        function showPatrolDetails(container, patrol, date) {
            const qrScans = patrol.events.filter(e => e.type === 'qrScan').sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
            const photos = patrol.events.filter(e => e.type === 'photo');
            const locations = patrol.events
                .filter(e => e.latitude && e.longitude)
                .map(e => [e.latitude, e.longitude]);
            const heatLocations = locations.map(loc => [...loc, 0.8]);

            let detailsHtml = '<div class="space-y-6">';
            detailsHtml += `<div>
                <div class="flex justify-center gap-2 mb-2">
                    <button id="map-view-heatmap" class="map-view-toggle active px-4 py-1 rounded-full text-sm font-semibold transition-colors">Mapa de Calor</button>
                    <button id="map-view-route" class="map-view-toggle bg-gray-200 text-gray-700 px-4 py-1 rounded-full text-sm font-semibold transition-colors">Mapa de Rota</button>
                </div>
                <div id="map-container" class="bg-gray-200 h-64 w-full rounded-lg"></div>
            </div>`;
            
            if (qrScans.length > 0) {
                detailsHtml += '<div><h4 class="font-bold mb-2 text-base text-[var(--text-secondary)]">Pontos Registrados</h4><div class="space-y-2">';
                qrScans.forEach(scan => {
                    const time = safeTimestampToDate(scan.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    detailsHtml += `<div class="bg-white p-3 rounded-lg border border-[var(--border-color)]">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-sm">${scan.checkpointName} <span class="text-xs text-gray-500">(${scan.qrData})</span></p>
                                <span class="font-bold text-sm text-[var(--primary-blue)]">${time}</span>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                Local: <a href="https://www.google.com/maps/search/?api=1&query=${scan.latitude},${scan.longitude}" target="_blank" class="text-blue-600 hover:underline">${scan.latitude.toFixed(4)}, ${scan.longitude.toFixed(4)}</a>
                            </div>
                        </div>`;
                });
                detailsHtml += '</div></div>';
            }
            if (photos.length > 0) {
                detailsHtml += `<div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-base text-[var(--text-secondary)]">Fotos</h4>
                            <button id="download-zip-btn" class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-lg hover:bg-green-700">Baixar (.zip)</button>
                        </div>
                        <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            ${photos.map((p, index) => `<img src="${p.photoBase64}" class="w-full h-32 object-cover rounded-lg shadow-md cursor-pointer" data-photo-index="${index}">`).join('')}
                        </div>
                    </div>`;
            }
            container.innerHTML = detailsHtml + '</div>';

            container.querySelectorAll('[data-photo-index]').forEach(el => {
                el.addEventListener('click', () => {
                    openPhotoGalleryModal(photos, parseInt(el.dataset.photoIndex));
                });
            });

            if (photos.length > 0) {
                container.querySelector('#download-zip-btn').addEventListener('click', async () => {
                    showToast('Preparando arquivo .zip...');
                    const zip = new JSZip();
                    const photoPromises = photos.map((photo, index) => fetch(photo.photoBase64).then(res => res.blob()).then(blob => {
                        const time = safeTimestampToDate(photo.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/:/g, '-');
                        zip.file(`foto-${index + 1}-${time}.jpg`, blob);
                    }));
                    await Promise.all(photoPromises);
                    zip.generateAsync({type:"blob"}).then(content => {
                        const link = document.createElement('a');
                        const safeDate = date.replace(/[^a-z0-9]/gi, '-');
                        link.href = URL.createObjectURL(content);
                        link.download = `Ronda-${patrol.patrolName.replace(/[^a-z0-9]/gi, '-')}-${safeDate}.zip`;
                        link.click();
                        showToast('Download iniciado!');
                    });
                });
            }

            const mapContainerEl = document.getElementById('map-container');
            if (locations.length > 0) {
                setTimeout(() => {
                    if (mapContainerEl && !mapContainerEl._leaflet_id) {
                        mapInstance = L.map('map-container').setView(locations[0], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                        
                        let currentMapLayer = null;

                        const renderMap = (type) => {
                            if(currentMapLayer) mapInstance.removeLayer(currentMapLayer);
                            
                            const routeBtn = container.querySelector('#map-view-route');
                            const heatmapBtn = container.querySelector('#map-view-heatmap');
                            routeBtn.classList.toggle('active', type === 'route');
                            heatmapBtn.classList.toggle('active', type === 'heatmap');
                            routeBtn.classList.toggle('bg-gray-200', type !== 'route');
                            heatmapBtn.classList.toggle('bg-gray-200', type !== 'heatmap');


                            if (type === 'route') {
                                const routeLayerGroup = L.layerGroup();
                                L.polyline(locations, { color: '#0A3D62', weight: 5 }).addTo(routeLayerGroup);
                                
                                patrol.events.forEach(event => {
                                    if(event.latitude && event.longitude) {
                                        const time = safeTimestampToDate(event.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                        let popupContent = `<b>Hora:</b> ${time}`;
                                        if(event.type === 'qrScan') popupContent = `<b>QR: ${event.checkpointName}</b><br>${popupContent}`;
                                        if(event.type === 'photo') popupContent = `<b>Foto Tirada</b><br>${popupContent}<br><img src="${event.photoBase64}" class="w-24 h-auto mt-1">`;
                                        L.marker([event.latitude, event.longitude]).bindPopup(popupContent).addTo(routeLayerGroup);
                                    }
                                });
                                currentMapLayer = routeLayerGroup;
                                mapInstance.addLayer(currentMapLayer);
                                if(locations.length > 1) mapInstance.fitBounds(locations);

                            } else if (type === 'heatmap') {
                                currentMapLayer = L.heatLayer(heatLocations, {radius: 25, blur: 15, maxZoom: 17});
                                mapInstance.addLayer(currentMapLayer);
                            }
                        };
                        
                        container.querySelector('#map-view-route').addEventListener('click', () => renderMap('route'));
                        container.querySelector('#map-view-heatmap').addEventListener('click', () => renderMap('heatmap'));

                        renderMap('heatmap');
                        mapInstance.invalidateSize();
                    }
                }, 150);
            } else {
                 mapContainerEl.innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum dado de localização para exibir.</p>';
            }
        }
        
        function loadPatrols() {
            const q = query(collection(db, `artifacts/${appId}/public/data/patrols`));
            onSnapshot(q, (querySnapshot) => {
                patrols = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                
                const patrolScreen = document.getElementById('admin-patrols-screen');
                if (patrolScreen && patrolScreen.parentElement.id !== 'screen-templates') {
                    renderPatrols();
                }
            });
        }

function renderPatrols() {
            const screen = screens.adminPatrols;
            screen.innerHTML = `<div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg">Roteiros de Ronda</h3>
                    <button id="add-patrol-btn" class="bg-[var(--primary-blue)] text-white font-bold px-4 py-2 rounded-lg hover:bg-[var(--accent-blue)] text-sm">Novo Roteiro</button>
                </div>
                <div id="patrols-list" class="space-y-3"></div>`;
            const listDiv = screen.querySelector('#patrols-list');
            listDiv.innerHTML = patrols.length === 0 ? '<p class="text-center text-gray-500 p-4">Nenhum roteiro criado.</p>' : patrols.map(p => {
                const site = sites.find(s => s.id === p.siteId);
                return `
                <div class="bg-white p-4 rounded-xl border border-[var(--border-color)]">
                    <div class="flex justify-between items-start">
                         <div>
                            <p class="font-semibold text-[var(--text-primary)]">${p.name}</p>
                            <p class="text-sm text-[var(--text-secondary)]">${p.checkpoints.length} ponto(s) • ${p.timeLimitMinutes || 'N/A'} min</p>
                            <p class="text-xs font-semibold mt-1 ${site ? 'text-purple-700' : 'text-yellow-600'}">${site ? site.name : 'Não associado / Invisível'}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button data-action="edit-patrol" data-id="${p.id}" class="p-2 text-blue-500 hover:bg-blue-100 rounded-full flex-shrink-0" title="Editar">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293a1 1 0 01-.39.246l-4 1a1 1 0 01-1.255-1.255l1-4a1 1 0 01.246-.39l7.293-7.293zM14 7l2-2m-4 12v1a1 1 0 01-1 1H6a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v2z" /></svg>
                            </button>
                            <button data-action="delete-patrol" data-id="${p.id}" class="p-2 text-red-500 hover:bg-red-100 rounded-full flex-shrink-0" title="Excluir">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t text-sm space-y-1">
                        ${p.checkpoints.map(c => `<div class="flex items-center gap-2"><svg class="h-4 w-4 text-purple-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10" /></svg><span class="font-medium">${c.name}</span> <span class="text-gray-500">(${c.qrContent})</span></div>`).join('')}
                    </div>
                </div>`
            }).join('');
            
            screen.querySelector('#add-patrol-btn').addEventListener('click', () => openPatrolModal());
            screen.querySelector('#patrols-list').addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                const id = target.dataset.id;
        
                if (action === 'delete-patrol' && confirm("Tem certeza que deseja excluir este roteiro?")) {
                    deleteDoc(doc(db, `artifacts/${appId}/public/data/patrols`, id))
                        .then(() => {
                            showToast("Roteiro excluído!");
                        }).catch(() => showToast("Erro ao excluir.", true));
                } else if (action === 'edit-patrol') {
                    const patrolToEdit = patrols.find(p => p.id === id);
                    if (patrolToEdit) {
                        openPatrolModal(patrolToEdit);
                    }
                }
            });
        }
        
        function loadCheckpoints() {
            const q = query(collection(db, `artifacts/${appId}/public/data/checkpoints`));
            onSnapshot(q, (querySnapshot) => {
                checkpoints = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (document.getElementById('admin-checkpoints-screen')?.firstChild) {
                    renderCheckpoints();
                }
            });
        }
        
        function renderCheckpoints() {
            const screen = screens.adminCheckpoints;
            screen.innerHTML = `<div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg">Pontos (QR Codes)</h3>
                    <button id="add-checkpoint-btn" class="bg-[var(--primary-blue)] text-white font-bold px-4 py-2 rounded-lg hover:bg-[var(--accent-blue)] text-sm">Novo Ponto</button>
                </div>
                <div id="checkpoints-list" class="space-y-4"></div>`;
            const listDiv = screen.querySelector('#checkpoints-list');
        
            if (checkpoints.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum ponto criado.</p>';
                return;
            }
        
            const checkpointsByCategory = checkpoints.reduce((acc, c) => {
                const category = c.category || 'Não categorizado';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(c);
                return acc;
            }, {});
        
            let html = '';
            for (const category in checkpointsByCategory) {
                const categoryId = category.replace(/\s+/g, '-');
                html += `
                    <div class="bg-gray-100 p-4 rounded-xl shadow-sm border border-gray-200">
                        <button class="w-full flex justify-between items-center font-bold text-[var(--text-primary)] text-left" data-action="toggle-category" data-target="${categoryId}">
                            <span>${category} (${checkpointsByCategory[category].length})</span>
                            <svg class="w-5 h-5 transform transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="${categoryId}" class="mt-4 space-y-3 hidden">
                            ${checkpointsByCategory[category].map(c => `
                                <div class="bg-white p-4 rounded-xl flex justify-between items-center border">
                                    <div>
                                        <p class="font-semibold">${c.name}</p>
                                        <p class="text-sm text-gray-500">QR: ${c.qrContent}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button data-action="view-qr" data-name="${c.name}" data-qr="${c.qrContent}" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full" title="Ver QR Code">
                                            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10" /></svg>
                                        </button>
                                        <button data-action="add-location" data-id="${c.id}" data-name="${c.name}" data-location='${JSON.stringify(c.location || null)}' class="p-2 ${c.location ? 'text-green-600 hover:bg-green-100' : 'text-blue-600 hover:bg-blue-100'} rounded-full" title="${c.location ? 'Editar Localização' : 'Adicionar Localização'}">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <button data-action="delete-checkpoint" data-id="${c.id}" class="p-2 text-red-500 hover:bg-red-100 rounded-full" title="Excluir Ponto">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            listDiv.innerHTML = html;
        
            screen.querySelector('#add-checkpoint-btn').addEventListener('click', () => {
                const uniqueCategories = [...new Set(checkpoints.map(c => c.category).filter(Boolean))].sort();
                let categoryOptions = `<option value="">-- Selecionar Categoria --</option>`;
                uniqueCategories.forEach(cat => {
                    categoryOptions += `<option value="${cat}">${cat}</option>`;
                });
                
                openModal('Novo Ponto de Verificação', `<div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Nome do Ponto</label>
                            <input id="checkpoint-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Texto do QR Code</label>
                            <input id="checkpoint-qr-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Categoria (Localização)</label>
                            <select id="checkpoint-category-select" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                                ${categoryOptions}
                                <option value="new-category">-- Adicionar nova categoria --</option>
                            </select>
                            <input id="new-category-input" type="text" placeholder="Nome da nova categoria" class="w-full mt-2 px-4 py-3 rounded-lg bg-gray-100 shadow-sm hidden">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button>
                        <button id="save-checkpoint-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar e Gerar QR</button>
                    </div>`);
        
                const categorySelect = document.getElementById('checkpoint-category-select');
                const newCategoryInput = document.getElementById('new-category-input');
                categorySelect.addEventListener('change', () => {
                    newCategoryInput.classList.toggle('hidden', categorySelect.value !== 'new-category');
                });
            });
        
            listDiv.addEventListener('click', async (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action, target: categoryId, id, name, qr, location } = target.dataset;
        
                if (action === 'toggle-category') {
                    const content = document.getElementById(categoryId);
                    const icon = target.querySelector('svg');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                } else if (action === 'view-qr') {
                    displayGeneratedQRCode(name, qr);
                } else if (action === 'add-location') {
                    const currentLocation = location ? JSON.parse(location) : null;
                    openLocationMethodChoiceModal(id, name, currentLocation);
                } else if (action === 'delete-checkpoint') {
                    if (!confirm("Tem certeza que deseja excluir este ponto? Ele será removido de TODOS os roteiros que o utilizam.")) {
                        return;
                    }

                    showToast("Excluindo ponto e atualizando roteiros...");

                    try {
                        const checkpointToDelete = checkpoints.find(c => c.id === id);
                        if (!checkpointToDelete) throw new Error("Ponto não encontrado para exclusão.");
                        
                        const qrContentToDelete = checkpointToDelete.qrContent;

                        const affectedPatrols = patrols.filter(p =>
                            p.checkpoints.some(cp => cp.qrContent === qrContentToDelete)
                        );

                        const updatePromises = affectedPatrols.map(patrol => {
                            const updatedCheckpoints = patrol.checkpoints.filter(cp => cp.qrContent !== qrContentToDelete);
                            const patrolRef = doc(db, `artifacts/${appId}/public/data/patrols`, patrol.id);
                            return updateDoc(patrolRef, { checkpoints: updatedCheckpoints });
                        });

                        await Promise.all(updatePromises);
                        
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/checkpoints`, id));

                        showToast("Ponto excluído com sucesso!");
                        
                    } catch (error) {
                        console.error("Erro ao excluir o ponto:", error);
                        showToast("Ocorreu um erro ao excluir o ponto.", true);
                    }
                }
            });
        }
        
        function openLocationMethodChoiceModal(checkpointId, checkpointName, currentLoc) {
            const modalHtml = `
                <p class="text-center text-gray-600 mb-6">Como você deseja definir a localização?</p>
                <div class="space-y-3">
                    <button id="loc-choice-gps" class="w-full flex items-center gap-4 text-left p-4 rounded-lg bg-white hover:bg-gray-50 border transition-colors">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold">Usar Minha Localização</p>
                            <p class="text-sm text-gray-500">Alta precisão, ideal para o local.</p>
                        </div>
                    </button>
                    <button id="loc-choice-map" class="w-full flex items-center gap-4 text-left p-4 rounded-lg bg-white hover:bg-gray-50 border transition-colors">
                         <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 6l6-3"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold">Escolher no Mapa</p>
                            <p class="text-sm text-gray-500">Para definir a localização remotamente.</p>
                        </div>
                    </button>
                </div>
            `;
            const context = { checkpointId, checkpointName, currentLoc };
            openModal(`Adicionar Local: ${checkpointName}`, modalHtml, { context });
        }
        
        function openAddLocationHereModal(checkpointId, checkpointName) {
            let watchId = null;
            let bestPosition = null;
            let mapInstance = null;
            let markerInstance = null;

            const modalHtml = `
                <div class="text-center space-y-4">
                    <p id="location-instructions" class="text-sm text-gray-600">Aguarde enquanto calibramos sua localização. Permaneça parado para maior precisão.</p>
                    <div id="location-status" class="flex flex-col items-center justify-center min-h-[12rem]">
                        <div id="location-preview-map" class="h-48 w-full bg-gray-200 rounded-lg z-0 mb-3">
                            <div class="flex items-center justify-center h-full text-gray-500">
                                <span class="loader"></span>
                            </div>
                        </div>
                        <p id="accuracy-text" class="font-semibold text-lg text-gray-500">Obtendo sinal...</p>
                        <p id="coords-text" class="font-mono text-xs"></p>
                    </div>
                    <button id="save-location-btn" disabled class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg opacity-50 cursor-not-allowed">
                        Salvar Localização
                    </button>
                </div>`;

            openModal(`Definir Local: ${checkpointName}`, modalHtml, { 
                onClose: () => {
                    if (watchId) navigator.geolocation.clearWatch(watchId);
                    if (mapInstance) {
                        mapInstance.remove();
                        mapInstance = null;
                    }
                }
            });

            const saveBtn = document.getElementById('save-location-btn');
            const instructionsP = document.getElementById('location-instructions');
            const accuracyText = document.getElementById('accuracy-text');
            const coordsText = document.getElementById('coords-text');

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    if (!bestPosition || accuracy < bestPosition.accuracy) {
                        bestPosition = position.coords;
                    }
                    if (!mapInstance) {
                        const mapEl = document.getElementById('location-preview-map');
                        if (mapEl) {
                            mapEl.innerHTML = '';
                            mapInstance = L.map('location-preview-map').setView([latitude, longitude], 18);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                            markerInstance = L.marker([latitude, longitude]).addTo(mapInstance);
                            setTimeout(() => mapInstance.invalidateSize(), 200);
                        }
                    } else {
                        mapInstance.setView([latitude, longitude]);
                        markerInstance.setLatLng([latitude, longitude]);
                    }
                    accuracyText.textContent = `Precisão: ${accuracy.toFixed(1)} metros`;
                    accuracyText.className = `font-semibold text-lg ${accuracy <= 10 ? 'text-green-600' : 'text-orange-500'}`;
                    coordsText.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    if (accuracy <= 15) {
                        instructionsP.textContent = "Precisão ideal atingida! Você já pode salvar.";
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        instructionsP.textContent = "Aguardando um sinal mais preciso (< 15m)...";
                    }
                },
                (error) => {
                    document.getElementById('location-status').innerHTML = '<p class="text-red-500 text-center p-4">Não foi possível obter a localização. Verifique as permissões do seu navegador e tente novamente.</p>';
                    if (watchId) navigator.geolocation.clearWatch(watchId);
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );

            saveBtn.addEventListener('click', async (e) => {
                if (!bestPosition) {
                    showToast("Aguarde uma localização válida ser encontrada.", true);
                    return;
                }
                const location = { latitude: bestPosition.latitude, longitude: bestPosition.longitude };
                if (watchId) navigator.geolocation.clearWatch(watchId);
                
                saveBtn.textContent = 'Salvando...';
                saveBtn.disabled = true;
                try {
                    const checkpointRef = doc(db, `artifacts/${appId}/public/data/checkpoints`, checkpointId);
                    await updateDoc(checkpointRef, { location });
                    showToast('Localização salva com a melhor precisão!');
                    closeModal();
                } catch (error) {
                    showToast('Erro ao salvar a localização.', true);
                    saveBtn.textContent = 'Salvar Localização';
                    saveBtn.disabled = false;
                }
            });
        }

        function openAddLocationRemoteModal(checkpointId, checkpointName, currentLoc) {
            const modalHtml = `
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">Use o campo de busca ou navegue pelo mapa. Arraste o marcador para a posição exata.</p>
                    <div id="location-picker-map" class="h-80 w-full bg-gray-200 rounded-lg z-0"></div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Coordenadas</p>
                        <p id="location-coords-display" class="font-mono text-sm font-semibold">${currentLoc ? `${currentLoc.latitude.toFixed(6)}, ${currentLoc.longitude.toFixed(6)}` : 'Mova o marcador'}</p>
                    </div>
                    <button id="save-location-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">
                        Salvar Localização
                    </button>
                </div>`;
            
            openModal(`Definir Local: ${checkpointName}`, modalHtml);

            setTimeout(() => {
                const initialLatLng = currentLoc ? [currentLoc.latitude, currentLoc.longitude] : [-22.413, -45.45];
                const map = L.map('location-picker-map').setView(initialLatLng, currentLoc ? 18 : 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                L.Control.geocoder({
                    defaultMarkGeocode: false,
                    placeholder: 'Buscar endereço...'
                }).on('markgeocode', function(e) {
                    const latlng = e.geocode.center;
                    map.setView(latlng, 18);
                    marker.setLatLng(latlng);
                    updateCoordsDisplay(latlng);
                }).addTo(map);

                const marker = L.marker(initialLatLng, { draggable: true }).addTo(map);

                const updateCoordsDisplay = (latlng) => {
                    document.getElementById('location-coords-display').textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                };

                marker.on('dragend', function(event) {
                    updateCoordsDisplay(event.target.getLatLng());
                });

                document.getElementById('save-location-btn').addEventListener('click', async () => {
                    const { lat, lng } = marker.getLatLng();
                    const location = { latitude: lat, longitude: lng };
                    
                    const btn = document.getElementById('save-location-btn');
                    btn.textContent = 'Salvando...';
                    btn.disabled = true;

                    try {
                        const checkpointRef = doc(db, `artifacts/${appId}/public/data/checkpoints`, checkpointId);
                        await updateDoc(checkpointRef, { location });
                        showToast('Localização salva com sucesso!');
                        closeModal();
                    } catch (error) {
                        showToast('Erro ao salvar a localização.', true);
                        btn.textContent = 'Salvar Localização';
                        btn.disabled = false;
                    }
                });
            }, 150);
        }
        
        function displayGeneratedQRCode(name, qrContent) {
            const modalHtml = `
                <div class="flex flex-col items-center text-center">
                    <div id="qr-code-container" class="p-4 bg-white rounded-lg shadow-inner"></div>
                    <p class="mt-4 font-semibold text-lg text-[var(--text-primary)]">${name}</p>
                    <div class="mt-6 flex gap-3 w-full">
                        <button data-action="close-modal" class="w-1/2 px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Fechar</button>
                        <button id="download-qr-btn" class="w-1/2 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Baixar</button>
                    </div>
                </div>`;

            openModal(`QR Code para: ${name}`, modalHtml);

            const qrCode = new QRCodeStyling({
                width: 320,
                height: 320,
                data: qrContent,
                image: "https://i.postimg.cc/brgLb82k/Smart-Route.png",
                dotsOptions: { color: "#0A3D62", type: "rounded" },
                backgroundOptions: { color: "#ffffff" },
                imageOptions: { crossOrigin: "anonymous", margin: 8, imageSize: 0.35 },
                cornersSquareOptions: { type: "extra-rounded", color: "#0A3D62" },
                cornersDotOptions: { type: "dot", color: "#0A3D62" },
                qrOptions: { errorCorrectionLevel: 'H' }
            });

            setTimeout(() => {
                const container = document.getElementById('qr-code-container');
                if (container) {
                    qrCode.append(container);
                }
            }, 100);

            document.getElementById('download-qr-btn').addEventListener('click', async () => {
                try {
                    const logoTopUrl = "https://i.postimg.cc/FKmK74Nh/Smart-Route-Horizontal.png";
                    const logoBottomUrl = "https://i.postimg.cc/FKmK74Nh/Smart-Route-Horizontal.png";

                    const highResQrCode = new QRCodeStyling({
                        width: 700,
                        height: 700,
                        data: qrContent,
                        image: "https://i.postimg.cc/brgLb82k/Smart-Route.png",
                        dotsOptions: { color: "#0A3D62", type: "rounded" },
                        backgroundOptions: { color: "#ffffff" },
                        imageOptions: { crossOrigin: "anonymous", margin: 8, imageSize: 0.35 },
                        cornersSquareOptions: { type: "extra-rounded", color: "#0A3D62" },
                        cornersDotOptions: { type: "dot", color: "#0A3D62" },
                        qrOptions: { errorCorrectionLevel: 'H' }
                    });

                    const blob = await highResQrCode.getRawData('png');
                    if (!blob) throw new Error("Não foi possível gerar os dados do QR Code.");

                    const loadImage = (urlOrBlob) => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.crossOrigin = "anonymous";
                            img.onload = () => {
                                if (typeof urlOrBlob !== 'string') URL.revokeObjectURL(img.src);
                                resolve(img);
                            };
                            img.onerror = (err) => {
                                if (typeof urlOrBlob !== 'string') URL.revokeObjectURL(img.src);
                                reject(err);
                            };
                            img.src = typeof urlOrBlob === 'string' ? urlOrBlob : URL.createObjectURL(urlOrBlob);
                        });
                    };
                    
                    const qrImage = await loadImage(blob);
                    const logoTop = await loadImage(logoTopUrl);
                    const logoBottom = await loadImage(logoBottomUrl);

                    const FINAL_CANVAS_WIDTH = 1080;
                    const FINAL_CANVAS_HEIGHT = 1400;
                    const PADDING = 50;

                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = FINAL_CANVAS_WIDTH;
                    finalCanvas.height = FINAL_CANVAS_HEIGHT;
                    const finalContext = finalCanvas.getContext('2d');

                    finalContext.fillStyle = '#ffffff';
                    finalContext.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                    
                    const logoTopHeight = 100;
                    const logoTopWidth = (logoTop.width / logoTop.height) * logoTopHeight;
                    finalContext.drawImage(logoTop, (FINAL_CANVAS_WIDTH - logoTopWidth) / 2, PADDING, logoTopWidth, logoTopHeight);

                    let currentY = PADDING + logoTopHeight + 30;

                    finalContext.fillStyle = '#0A3D62';
                    finalContext.font = 'bold 45px Arial, sans-serif';
                    finalContext.textAlign = 'center';
                    finalContext.textBaseline = 'top';
                    finalContext.fillText('SUPERVISÃO', FINAL_CANVAS_WIDTH / 2, currentY);
                    currentY += 60;

                    const maxTextWidth = FINAL_CANVAS_WIDTH - (PADDING * 2);
                    const wrapText = (context, text, x, y, maxWidth, lineHeight) => {
                        const words = text.split(' ');
                        let line = '';
                        for (let n = 0; n < words.length; n++) {
                            const testLine = line + words[n] + ' ';
                            const metrics = context.measureText(testLine);
                            const testWidth = metrics.width;
                            if (testWidth > maxWidth && n > 0) {
                                context.fillText(line, x, y);
                                line = words[n] + ' ';
                                y += lineHeight;
                            } else {
                                line = testLine;
                            }
                        }
                        context.fillText(line, x, y);
                        return y + lineHeight;
                    };

                    finalContext.font = '40px Arial, sans-serif';
                    currentY = wrapText(finalContext, name, FINAL_CANVAS_WIDTH / 2, currentY, maxTextWidth, 50);
                    currentY += 40;

                    const qrCodeSize = 700;
                    finalContext.drawImage(qrImage, (FINAL_CANVAS_WIDTH - qrCodeSize) / 2, currentY, qrCodeSize, qrCodeSize);
                    currentY += qrCodeSize + 50;

                    const logoBottomHeight = 80;
                    const logoBottomWidth = (logoBottom.width / logoBottom.height) * logoBottomHeight;
                    finalContext.drawImage(logoBottom, (FINAL_CANVAS_WIDTH - logoBottomWidth) / 2, currentY, logoBottomWidth, logoBottomHeight);
                    
                    const link = document.createElement('a');
                    link.download = `QRCode-${name.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}.png`;
                    link.href = finalCanvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Download iniciado!');
                    
                } catch (error) {
                    console.error("Erro ao gerar QR Code para download:", error);
                    showToast("Erro ao gerar o QR Code. Tente novamente.", true);
                }
            });
        }

        function loadProfile(container) {
            const targetContainer = container || (window.innerWidth >= 1024 ? mainContentDesktop : screens.profile);
            targetContainer.innerHTML = `
                <div class="space-y-6 max-w-md mx-auto">
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Nome Completo</label>
                        <input id="profile-name-input" type="text" value="${userData.name || ''}" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Email</label>
                        <p class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg">${userData.email}</p>
                    </div>
                </div>
                <button id="save-profile-button" class="w-full mt-8 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg max-w-md mx-auto block">Salvar Alterações</button>`;
            
            targetContainer.querySelector('#save-profile-button').addEventListener('click', async () => {
                const newName = targetContainer.querySelector('#profile-name-input').value;
                if (newName && newName !== userData.name) {
                    await updateDoc(doc(db, "users", userData.id), { name: newName });
                    userData.name = newName;
                    showToast("Perfil atualizado!");
                    updateUserInfo();
                }
            });
        }
        
        function renderReportContent(patrols, days) {
            const reportsContent = document.getElementById('reports-content');
            if (!reportsContent) return;

            const completedPatrols = patrols.filter(p => p.status === 'completed');

            const totalPatrols = completedPatrols.length;
            const activeGuards = new Set(completedPatrols.map(p => p.userId)).size;
            const totalScans = completedPatrols.reduce((sum, p) => sum + (p.events.filter(e => e.type === 'qrScan').length), 0);
            const totalDuration = completedPatrols.reduce((sum, p) => {
                const duration = safeTimestampToDate(p.endTime) - safeTimestampToDate(p.startTime);
                return sum + (isNaN(duration) ? 0 : duration);
            }, 0);
            const avgDuration = totalPatrols > 0 ? (totalDuration / totalPatrols / 60000) : 0;

            const kpiIcons = {
                total: `<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 6l6-3"></path></svg>`,
                duration: `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                guards: `<svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>`,
                scans: `<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>`
            };
            
            const guardCounts = completedPatrols.reduce((acc, p) => {
                acc[p.userName] = (acc[p.userName] || 0) + 1;
                return acc;
            }, {});
            const leaderboard = Object.entries(guardCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const patrolsByDay = completedPatrols.reduce((acc, p) => {
                const day = safeTimestampToDate(p.endTime).toISOString().split('T')[0];
                acc[day] = (acc[day] || 0) + 1;
                return acc;
            }, {});
            const chartLabels = Object.keys(patrolsByDay).sort();
            const chartData = chartLabels.map(label => patrolsByDay[label]);
            
            reportsContent.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    ${createKpiCard("Total de Rondas", totalPatrols, "", kpiIcons.total, 'bg-blue-100')}
                    ${createKpiCard("Duração Média", avgDuration.toFixed(0), "min", kpiIcons.duration, 'bg-green-100')}
                    ${createKpiCard("Vigilantes Ativos", activeGuards, "", kpiIcons.guards, 'bg-purple-100')}
                    ${createKpiCard("Pontos Verificados", totalScans, "", kpiIcons.scans, 'bg-yellow-100')}
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border h-96">
                        <h4 class="font-bold mb-4 text-[var(--text-secondary)]">Atividade de Rondas</h4>
                        <div class="relative h-full w-full max-h-72"><canvas id="patrols-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h4 class="font-bold mb-4 text-[var(--text-secondary)]">Ranking de Vigilantes</h4>
                        <div class="space-y-2">
                        ${leaderboard.length > 0 ? leaderboard.map((item, index) => `
                            <div class="flex items-center gap-3 p-2 rounded-lg transition-colors hover:bg-gray-50">
                                <span class="font-bold text-lg text-gray-400 w-6">${index + 1}</span>
                                <div class="w-9 h-9 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-sm flex-shrink-0">${(item[0] || 'U').charAt(0)}</div>
                                <span class="font-semibold flex-grow truncate">${item[0] || 'N/A'}</span>
                                <span class="font-bold text-lg text-[var(--primary-blue)]">${item[1]}</span>
                            </div>
                        `).join('') : '<p class="text-center text-sm text-gray-500 pt-8">Nenhuma ronda no período.</p>'}
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border">
                    <h4 class="font-bold mb-4 text-[var(--text-secondary)]">Atividade Recente</h4>
                    <div class="space-y-1">
                     ${patrols.slice(0, 5).map(p => `
                        <div class="p-3 rounded-lg flex justify-between items-center transition-colors hover:bg-gray-50">
                            <div>
                                <p class="font-semibold text-sm">${p.patrolName}</p>
                                <p class="text-xs text-gray-500">Por ${p.userName}</p>
                            </div>
                            <span class="text-sm font-medium text-gray-600">${safeTimestampToDate(p.endTime).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                     `).join('')}
                     ${patrols.length === 0 ? '<p class="text-center text-sm text-gray-500 py-4">Nenhuma atividade recente.</p>' : ''}
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border mt-6">
                    <h4 class="font-bold mb-4 text-[var(--text-secondary)]">Alertas de Pânico Recentes</h4>
                    <div id="panic-alerts-history" class="space-y-2">
                         <div class="flex justify-center items-center p-4"><span class="loader"></span></div>
                    </div>
                </div>
            `;
            
            const ctx = document.getElementById('patrols-chart')?.getContext('2d');
            if (ctx) {
                if (reportChart) reportChart.destroy();
                reportChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: chartLabels, datasets: [{
                        label: 'Rondas por Dia', data: chartData, borderColor: 'var(--primary-blue)',
                        backgroundColor: 'rgba(10, 61, 98, 0.1)', borderWidth: 2, tension: 0.4, fill: true,
                        pointBackgroundColor: 'var(--primary-blue)', pointBorderColor: '#fff', pointHoverRadius: 6
                    }] },
                    options: {
                        scales: {
                            y: { beginAtZero: true, ticks: { precision: 0 }, grid: { drawBorder: false } },
                            x: { type: 'time', time: { unit: days > 7 ? 'week' : 'day', displayFormats: { day: 'dd/MM' } }, grid: { display: false } }
                        },
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: {
                            backgroundColor: '#1A202C', titleFont: { weight: 'bold' }, bodyFont: { size: 14 },
                            padding: 12, cornerRadius: 8, displayColors: false
                        }}
                    }
                });
            }
        }
        
        function createKpiCard(title, value, unit, icon, iconBgClass) {
            return `
                <div class="bg-white p-4 rounded-xl shadow-md border flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full ${iconBgClass} flex items-center justify-center flex-shrink-0">
                        ${icon}
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">${title}</p>
                        <p class="text-2xl font-extrabold text-[var(--primary-blue)]">${value} <span class="text-lg font-semibold">${unit}</span></p>
                    </div>
                </div>
            `;
        }
        
        async function loadAlertsScreen() {
            const container = screens.adminAlerts;
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border">
                    <h3 class="font-bold text-lg mb-1">Enviar Novo Alerta</h3>
                    <p class="text-gray-500 mb-4 text-sm">A mensagem será enviada para todos os vigilantes.</p>
                    <textarea id="alert-message-input" class="w-full p-3 rounded-lg bg-gray-100 border-2" rows="4"></textarea>
                    <button id="send-alert-btn" class="w-full mt-4 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg">Enviar Alerta</button>
                </div>`;
            container.querySelector('#send-alert-btn').addEventListener('click', async () => {
                const message = document.getElementById('alert-message-input').value.trim();
                if (!message) return showToast("A mensagem não pode estar vazia.", true);
                await setDoc(doc(db, `artifacts/${appId}/public/data/alerts`, "latest"), { message, timestamp: new Date() });
                showToast("Alerta enviado!");
                document.getElementById('alert-message-input').value = '';
            });
        }

        onAuthStateChanged(auth, async (user) => {
            const showAuthMessage = (message) => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('admin-app-container').classList.add('hidden');
                const messageScreen = document.getElementById('auth-message-screen');
                document.getElementById('auth-message-text').textContent = message;
                messageScreen.classList.remove('hidden');
            };

            const redirectTo = (page) => {
                try {
                    const currentPath = window.location.pathname;
                    const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
                    window.location.replace(newPath);
                } catch (e) {
                    console.error("Falha ao redirecionar:", e);
                    showAuthMessage(`Sessão encerrada. Por favor, retorne para a página de login.`);
                }
            };

            if (user) {
                onSnapshot(doc(db, "users", user.uid), async (userDoc) => {
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        if (data.role === 'admin') {
                            if (!uiInitialized) { // Executa a inicialização completa apenas uma vez
                                await startAdminApp(user, data);
                                document.getElementById('loading-screen').classList.add('hidden');
                                document.getElementById('admin-app-container').classList.remove('hidden');
                            } else { // Para atualizações subsequentes, apenas atualiza os dados do usuário
                                userData = { id: user.uid, ...data };
                                updateUserInfo(); // Atualiza a UI com os novos dados se houver
                            }
                        } else {
                            redirectTo('guard.html');
                        }
                    } else {
                        showAuthMessage('Seus dados de administrador não foram encontrados. Contate o suporte.');
                        await signOut(auth);
                    }
                }, (error) => {
                    console.error("Erro ao escutar dados do usuário:", error);
                    showAuthMessage('Ocorreu um erro ao verificar suas credenciais.');
                    signOut(auth);
                });
            } else {
                redirectTo('index.html');
            }
        });
    </script>
</body>
</html>