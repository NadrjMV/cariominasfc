<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartRoute - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="icon" href="https://i.postimg.cc/4dNYygZr/Smart-Route-Logo.png">

    <style>
        :root {
            --primary-blue: #0A3D62;
            --accent-blue: #2980B9;
            --light-bg: #F7F9FC;
            --text-primary: #1A202C;
            --text-secondary: #5A6A7B;
            --border-color: #E2E8F0;
            --danger-red: #E53E3E;
        }
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-bg); }
        .logo-img { object-fit: contain; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #d1d5db;
            border-bottom-color: var(--primary-blue); border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .nav-item.active {
            color: var(--primary-blue);
            background-color: #EFF6FF;
            font-weight: 600;
        }
        .bottom-nav-item.active svg, .bottom-nav-item.active span {
            color: var(--primary-blue);
        }

        .notification-dot {
            position: absolute; top: 0; right: 0; width: 10px; height: 10px;
            background-color: #EF4444; border-radius: 50%; border: 2px solid white;
        }
        #main-app-container, #app-shell {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #main-content-mobile {
            padding-bottom: 10rem;
        }
        #panic-button {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="h-screen flex flex-col justify-center items-center bg-white">
        <img src="https://i.postimg.cc/4dNYygZr/Smart-Route-Logo.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <span class="loader"></span>
        <p class="mt-4 text-lg font-medium text-[var(--text-secondary)]">Carregando...</p>
    </div>

    <div id="auth-message-screen" class="hidden h-screen flex flex-col justify-center items-center bg-white p-4 text-center">
        <div id="auth-message-content" class="w-full max-w-md">
            <!-- Conteúdo dinâmico será injetado aqui -->
        </div>
    </div>

    <div id="main-app-container" class="hidden">
        <div id="guard-desktop-layout" class="hidden lg:flex">
             <div class="w-64 bg-white shadow-md h-screen fixed top-0 left-0 p-6 flex flex-col">
                <img src="https://i.postimg.cc/FKmK74Nh/Smart-Route-Horizontal.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
                <nav id="guard-desktop-nav" class="flex-grow space-y-2"></nav>
                <button id="logout-button-desktop" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair da Conta</span>
                </button>
            </div>
            <div class="flex-1 lg:ml-64">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm sticky top-0 z-20 border-b border-[var(--border-color)]">
                    <h1 id="header-title-desktop" class="text-xl font-bold">Dashboard</h1>
                     <div class="relative">
                        <button id="notification-bell-desktop" class="hidden p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div id="notification-dot-desktop" class="hidden notification-dot"></div>
                        </button>
                    </div>
                </header>
                <main id="main-content-guard-desktop" class="p-8"></main>
            </div>
        </div>
        <div id="mobile-layout" class="lg:hidden">
            <div id="app-shell" class="max-w-lg mx-auto bg-[var(--light-bg)] min-h-screen shadow-2xl relative">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm fixed top-0 w-full max-w-lg z-20 h-16">
                    <button id="menu-button-mobile" class="p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="header-title-mobile" class="text-xl font-bold">Dashboard</h1>
                    <div class="w-10 relative">
                        <button id="notification-bell-mobile" class="hidden p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div id="notification-dot-mobile" class="hidden notification-dot"></div>
                        </button>
                    </div>
                </header>
                <main id="main-content-mobile" class="pt-20 px-5"></main>
                <div id="menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
                <div id="side-menu-mobile" class="transition-transform transform -translate-x-full fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-40 p-6 flex flex-col text-[var(--text-primary)]">
                    <img src="https://i.postimg.cc/brgLb82k/Smart-Route.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
                    <nav id="side-menu-nav-mobile" class="flex-grow space-y-2"></nav>
                    <button id="logout-button-mobile" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Sair da Conta</span>
                    </button>
                </div>
            </div>
        </div>

        <button id="panic-button" class="fixed bottom-24 lg:bottom-8 right-5 lg:right-8 bg-[var(--danger-red)] text-white w-16 h-16 rounded-full flex flex-col items-center justify-center shadow-2xl z-30">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-12.728 12.728m12.728 0L5.636 5.636"></path></svg>
            <span class="text-xs font-bold">SOS</span>
        </button>

        <div id="camera-container" class="hidden fixed inset-0 bg-black z-50 flex flex-col justify-center items-center">
            <div id="qr-reader" class="w-full max-w-lg"></div>
            <video id="video-preview" autoplay playsinline class="hidden w-full h-auto"></video>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <div class="absolute bottom-5 w-full px-5 flex gap-4">
                <button id="capture-button" class="hidden w-full bg-green-500 text-white p-4 rounded-lg font-bold text-lg">Capturar</button>
                <button id="cancel-camera-button" class="w-full bg-red-500 text-white p-4 rounded-lg font-bold text-lg">Cancelar</button>
            </div>
        </div>

        <div id="photo-preview-container" class="hidden fixed inset-0 bg-black z-50 flex flex-col justify-center items-center p-4">
            <img id="photo-preview-img" src="" class="max-w-full max-h-[70vh] rounded-lg">
            <div class="absolute bottom-5 w-full px-5 grid grid-cols-2 gap-4">
                <button id="retake-photo-button" class="bg-yellow-500 text-white p-4 rounded-lg font-bold text-lg">Refazer</button>
                <button id="confirm-photo-button" class="bg-green-500 text-white p-4 rounded-lg font-bold text-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white text-[var(--text-primary)] rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button id="modal-close-button" class="text-3xl leading-none text-gray-400 hover:text-gray-800">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-[var(--light-bg)]"></div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <div id="screen-templates" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, where, getDocs, updateDoc, setDoc, orderBy, enableIndexedDbPersistence, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAqBwCgVJR_fH_QisTQZiIJE9B-2JC93vk",
            authDomain: "sunperyo.firebaseapp.com",
            projectId: "sunperyo",
            storageBucket: "sunperyo.appspot.com",
            messagingSenderId: "850650155716",
            appId: "1:850650155716:web:8bfb4799d92d701e421791"
        };
        const appId = "sunperyo-app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("A persistência do Firebase falhou, múltiplas abas abertas.");
            } else if (err.code == 'unimplemented') {
                console.error("Este navegador não suporta modo offline.");
            }
        });

        const mainAppContainer = document.getElementById('main-app-container');
        const loadingScreen = document.getElementById('loading-screen');
        const authMessageScreen = document.getElementById('auth-message-screen');
        const authMessageContent = document.getElementById('auth-message-content');
        const mainContentMobile = document.getElementById('main-content-mobile');
        const mainContentGuardDesktop = document.getElementById('main-content-guard-desktop');
        const headerTitleMobile = document.getElementById('header-title-mobile');
        const headerTitleDesktop = document.getElementById('header-title-desktop');
        const sideMenuMobile = document.getElementById('side-menu-mobile');
        const menuOverlay = document.getElementById('menu-overlay');
        const cameraContainer = document.getElementById('camera-container');
        const videoPreview = document.getElementById('video-preview');
        const photoCanvas = document.getElementById('photo-canvas');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const modalOverlay = document.getElementById('modal-overlay');

        let qrScanner = null;
        let videoStream = null;
        let allPatrols = [];
        let allSites = [];
        let currentUser = null;
        let userData = null;
        let mapInstance = null;
        let screens = {};
        let modalStack = [];
        let activePatrolSession = null;
        let patrolTimerInterval = null;
        let patrolSubmissionInProgress = false;
        let liveLocationInterval = null;
        let capturedPhotoBase64 = null;

        onAuthStateChanged(auth, async (user) => {
            const redirectTo = (page) => {
                try {
                    const currentPath = window.location.pathname;
                    const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
                    window.location.replace(newPath);
                } catch (e) {
                    console.error("Falha ao redirecionar:", e);
                    showSiteSelectionScreen(null, "Sessão encerrada. Por favor, retorne para a página de login.");
                }
            };

            if (user) {
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    onSnapshot(userDocRef, async (userDoc) => {
                        if (userDoc.exists()) {
                            const data = userDoc.data();
                            if (data.role === 'guard') {
                                // **NOVA LÓGICA DE VERIFICAÇÃO DE USINA**
                                if (!data.assignedSiteIds || data.assignedSiteIds.length === 0) {
                                    // Se o usuário não tem usina, mostra a tela de seleção
                                    await loadAllSites();
                                    showSiteSelectionScreen(user, data.name);
                                } else if (!userData) {
                                    // Se tem usina e é o primeiro login, inicia o app
                                    await startGuardApp(user, data);
                                } else {
                                    // Se já estava logado e algo mudou, atualiza os dados
                                    userData = { id: user.uid, ...data };
                                    loadGuardDashboard();
                                }
                            } else {
                                redirectTo('admin.html');
                            }
                        } else {
                            showSiteSelectionScreen(null, 'Seus dados de vigilante não foram encontrados. Contate o suporte.');
                            await signOut(auth);
                        }
                    });
                } catch (error) {
                    console.error("Erro na verificação de autenticação:", error);
                    showSiteSelectionScreen(null, 'Ocorreu um erro ao verificar suas credenciais.');
                    await signOut(auth);
                }
            } else {
                redirectTo('index.html');
            }
        });

        // **NOVA FUNÇÃO PARA TELA DE SELEÇÃO DE USINA**
        function showSiteSelectionScreen(user, userName, errorMessage = null) {
            loadingScreen.classList.add('hidden');
            mainAppContainer.classList.add('hidden');
            authMessageScreen.classList.remove('hidden');

            let siteOptionsHtml = allSites.length > 0
                ? allSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('')
                : '<option value="" disabled>Nenhuma usina disponível</option>';

            authMessageContent.innerHTML = `
                <div class="p-8 bg-white text-center rounded-2xl shadow-2xl">
                    <img src="https://i.postimg.cc/4dNYygZr/Smart-Route-Logo.png" alt="Logo Sun Plan" class="h-16 w-auto mx-auto mb-4 logo-img">
                    <h1 class="text-2xl font-bold text-[var(--primary-blue)]">Finalize seu Cadastro</h1>
                    <p class="text-[var(--text-secondary)] mt-4">Olá, ${userName || 'Vigilante'}. Para continuar, por favor, selecione a sua usina de trabalho. <strong>Esta ação só pode ser feita uma vez.</strong></p>
                    
                    <select id="pending-site-select" class="w-full mt-6 px-4 py-3 rounded-lg bg-gray-100 text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:bg-white focus:ring-0 transition-all appearance-none">
                        <option value="" disabled selected>Selecione uma usina...</option>
                        ${siteOptionsHtml}
                    </select>
                    
                    <p id="pending-error" class="text-red-500 text-center mt-2 hidden"></p>

                    <button id="confirm-site-button" class="w-full mt-6 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg hover:bg-[var(--accent-blue)]">Confirmar Usina</button>
                </div>
            `;

            if (errorMessage) {
                const errorP = document.getElementById('pending-error');
                errorP.textContent = errorMessage;
                errorP.classList.remove('hidden');
            }

            document.getElementById('confirm-site-button').addEventListener('click', async () => {
                const selectedSiteId = document.getElementById('pending-site-select').value;
                const errorP = document.getElementById('pending-error');
                
                if (!selectedSiteId) {
                    errorP.textContent = "Por favor, selecione uma usina.";
                    errorP.classList.remove('hidden');
                    return;
                }

                try {
                    const userRef = doc(db, "users", user.uid);
                    await updateDoc(userRef, {
                        assignedSiteIds: [selectedSiteId]
                    });
                    // Recarrega a página. O onAuthStateChanged vai rodar de novo e liberar o acesso.
                    location.reload();
                } catch (error) {
                    console.error("Erro ao salvar usina:", error);
                    errorP.textContent = "Ocorreu um erro ao salvar. Tente novamente.";
                    errorP.classList.remove('hidden');
                }
            });
        }

        async function startGuardApp(user, data) {
            authMessageScreen.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            
            currentUser = user;
            userData = { id: user.uid, ...data };

            initializeTemplates();
            await loadAllPatrols();
            checkForActiveSession();
            setupUI();
            requestInitialLocationPermission();
            setupPushNotifications(user, app, db);
        }
        
        async function setupPushNotifications(user, app, db) {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const messaging = getMessaging(app);
                    const vapidKey = 'BDQ21-KdyDMfULVF47hIx1MFeFvkFksh4K4ezde9kc6IEILRqBwlOm3BXCtBXqqjaB8GKBx37mBI_NZb9IccXlI';
                    const currentToken = await getToken(messaging, { vapidKey: vapidKey });
                    if (currentToken) {
                        await setDoc(doc(db, "users", user.uid), { fcmToken: currentToken }, { merge: true });
                    }
                    onMessage(messaging, (payload) => {
                        showToast(`Novo Alerta: ${payload.notification.title}`);
                    });
                }
            } catch (error) {
                console.error('Erro ao configurar notificações push:', error);
            }
        }

        function getStartOfCurrentPatrolDay() {
            const now = new Date();
            const startOfPatrolDay = new Date();
            if (now.getHours() < 6) {
                startOfPatrolDay.setDate(now.getDate() - 1);
            }
            startOfPatrolDay.setHours(6, 0, 0, 0);
            return startOfPatrolDay;
        }

        function initializeTemplates() {
            const templateContainer = document.getElementById('screen-templates');
            templateContainer.innerHTML = `
                <div id="guard-dashboard-screen"></div>
                <div id="guard-history-screen"></div>
                <div id="profile-screen"></div>
            `;
            screens = {
                guardDashboard: document.getElementById('guard-dashboard-screen'),
                guardHistory: document.getElementById('guard-history-screen'),
                profile: document.getElementById('profile-screen'),
            };
        }

        function setupUI() {
            const isDesktop = window.innerWidth >= 1024;
            document.getElementById('guard-desktop-layout').classList.toggle('hidden', !isDesktop);
            document.getElementById('mobile-layout').classList.toggle('hidden', isDesktop);
            
            updateNavigation();
            handleNavigation(null, 'guardDashboard', 'Dashboard');
            checkForAlerts();

            document.getElementById('logout-button-mobile').addEventListener('click', () => signOut(auth));
            document.getElementById('logout-button-desktop').addEventListener('click', () => signOut(auth));
            document.getElementById('menu-button-mobile').addEventListener('click', openSideMenu);
            menuOverlay.addEventListener('click', closeSideMenu);
            document.getElementById('side-menu-nav-mobile').addEventListener('click', handleNavigation);
            document.getElementById('guard-desktop-nav').addEventListener('click', handleNavigation);
            document.getElementById('modal-close-button').addEventListener('click', () => closeModal(true));
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'modal-overlay') closeModal();
            });
            document.getElementById('cancel-camera-button').addEventListener('click', stopCamera);
            document.getElementById('capture-button').addEventListener('click', capturePhoto);
            document.body.addEventListener('click', handleDashboardActions);
            
            document.getElementById('panic-button').addEventListener('click', confirmAndSendPanicAlert);
            document.getElementById('retake-photo-button').addEventListener('click', () => {
                photoPreviewContainer.classList.add('hidden');
                startCamera('photo');
            });
            document.getElementById('confirm-photo-button').addEventListener('click', confirmPhoto);
        }
        
        function navigateToScreen(screenName, title) {
            const isDesktop = window.innerWidth >= 1024;
            const mainContent = isDesktop ? mainContentGuardDesktop : mainContentMobile;
            const templateContainer = document.getElementById('screen-templates');

            if (mainContent.firstChild) {
                templateContainer.appendChild(mainContent.firstChild);
            }

            if (screens[screenName]) {
                mainContent.appendChild(screens[screenName]);
                headerTitleMobile.textContent = title;
                headerTitleDesktop.textContent = title;
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function openModal(title, contentHtml, state = {}) {
            state.title = title;
            state.contentHtml = contentHtml;
            modalStack.push(state);
            renderCurrentModal();
        }

        function renderCurrentModal() {
            if (modalStack.length === 0) {
                modalOverlay.classList.add('hidden');
                if (mapInstance) {
                    mapInstance.remove(); mapInstance = null;
                }
                return;
            }
            const currentState = modalStack[modalStack.length - 1];
            document.getElementById('modal-title').textContent = currentState.title;
            const modalBody = document.getElementById('modal-body');
            if (currentState.renderer) {
                currentState.renderer(modalBody);
            } else {
                modalBody.innerHTML = currentState.contentHtml;
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeModal(forceAll = false) {
            if (forceAll) {
                modalStack = [];
            } else if (modalStack.length > 0) {
                modalStack.pop();
            }
            renderCurrentModal();
        }
        
        function openSideMenu() {
            sideMenuMobile.classList.remove('-translate-x-full');
            menuOverlay.classList.remove('hidden');
            menuOverlay.style.opacity = '1';
        }

        function closeSideMenu() {
            sideMenuMobile.classList.add('-translate-x-full');
            menuOverlay.style.opacity = '0';
            setTimeout(() => menuOverlay.classList.add('hidden'), 300);
        }

        function loadGuardDashboard() {
            const container = screens.guardDashboard;
            if (activePatrolSession) {
                renderActivePatrolDashboard(container);
            } else {
                renderIdleDashboard(container);
            }
            checkAndRenderLocationStatus(container);
        }
        
        function renderIdleDashboard(container) {
             container.innerHTML = `
                <div class="mb-8 text-center lg:text-left">
                    <p class="text-[var(--text-secondary)] text-lg">Olá,</p>
                    <h2 class="text-4xl font-extrabold text-[var(--primary-blue)] -mt-1">${userData.name.split(' ')[0]}!</h2>
                </div>
                 <div class="text-center max-w-sm mx-auto">
                    <p class="text-[var(--text-secondary)]">Nenhuma ronda em andamento.</p>
                    <button data-action="start-patrol" class="w-full mt-4 bg-[var(--primary-blue)] text-white font-bold py-4 rounded-2xl hover:bg-[var(--accent-blue)] transition-all shadow-lg shadow-blue-900/20 transform hover:scale-105 text-lg">
                        Iniciar Ronda
                    </button>
                </div>
                <div id="location-status-container" class="mt-8 max-w-sm mx-auto"></div>`;
        }

        function renderActivePatrolDashboard(container) {
            const { patrolName, requiredCheckpoints, scannedCheckpoints, photoCount } = activePatrolSession;
            let checkpointsHtml = requiredCheckpoints.map(cp => {
                const isScanned = scannedCheckpoints.includes(cp.qrContent);
                return `
                    <div class="flex items-center gap-3 p-2 rounded-md ${isScanned ? 'bg-green-100' : 'bg-gray-100'}">
                        ${isScanned 
                            ? `<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`
                            : `<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2m-4 8v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2"></path></svg>`
                        }
                        <span class="text-sm ${isScanned ? 'line-through text-gray-500' : 'font-medium text-[var(--text-primary)]'}">${cp.name}</span>
                    </div>`;
            }).join('');
            
            container.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200/50 max-w-sm mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <p class="text-sm font-semibold text-[var(--text-secondary)]">Ronda em Andamento</p>
                            <h3 class="text-2xl font-bold text-[var(--primary-blue)] truncate">${patrolName}</h3>
                        </div>
                        <div id="patrol-timer" class="font-bold text-lg text-red-600 bg-red-100 px-3 py-1 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                         <p class="font-bold text-[var(--text-secondary)] text-sm mb-2">Checklist de Pontos</p>
                         <div class="space-y-2">${checkpointsHtml}</div>
                    </div>
                    <div class="mt-4 text-sm text-[var(--text-secondary)] font-medium text-center">
                        Fotos tiradas: ${photoCount} / 15
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button data-action="scan-qr" class="bg-gray-100 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-gray-200 transition-all transform hover:-translate-y-1">
                            <div class="p-4 bg-blue-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" class="text-[var(--primary-blue)]"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg></div>
                            <h3 class="font-bold text-base text-center">Escanear QR</h3>
                        </button>
                        <button data-action="take-photo" class="bg-gray-100 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-gray-200 transition-all transform hover:-translate-y-1 ${photoCount >= 15 ? 'opacity-50 cursor-not-allowed' : ''}" ${photoCount >= 15 ? 'disabled' : ''}>
                           <div class="p-4 bg-blue-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" class="text-[var(--primary-blue)]"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 0 1 2-2h.93a2 2 0 0 0 1.664-.89l.812-1.22A2 2 0 0 1 10.07 4h3.86a2 2 0 0 1 1.664.89l.812 1.22A2 2 0 0 0 18.07 7H19a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"></path><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg></div>
                           <h3 class="font-bold text-base text-center">Tirar Foto</h3>
                        </button>
                    </div>
                    <button data-action="finalize-patrol" class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">
                        Finalizar Ronda
                    </button>
                     <button data-action="cancel-patrol" class="w-full mt-2 bg-transparent text-red-600 font-semibold py-2 rounded-lg hover:bg-red-50 transition-colors text-sm">
                        Cancelar Ronda
                    </button>
                </div>
                <div id="location-status-container" class="mt-8 max-w-sm mx-auto"></div>`;
            startPatrolTimer();
        }

        function handleDashboardActions(e) {
            const action = e.target.closest('[data-action]')?.dataset.action;
            if (!action) return;

            switch(action) {
                case 'start-patrol':
                    promptToStartPatrol();
                    break;
                case 'scan-qr':
                    startCamera('qr');
                    break;
                case 'take-photo':
                    startCamera('photo');
                    break;
                case 'finalize-patrol':
                    attemptToFinalizePatrol();
                    break;
                case 'cancel-patrol':
                    openModal('Cancelar Ronda', `
                        <p>Tem certeza que deseja cancelar esta ronda? Todo o progresso será perdido.</p>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Não</button>
                            <button id="confirm-cancel-patrol" class="px-4 py-2 rounded-lg bg-[var(--danger-red)] text-white">Sim, Cancelar</button>
                        </div>
                    `);
                    document.getElementById('confirm-cancel-patrol').onclick = () => {
                        closeModal();
                        cancelPatrol();
                    };
                    break;
                 case 'select-patrol':
                    const patrolId = e.target.closest('[data-patrol-id]').dataset.patrolId;
                    const selectedPatrol = allPatrols.find(p => p.id === patrolId);
                    startPatrol(selectedPatrol);
                    closeModal();
                    break;
            }
        }
        
        async function getCompletedPatrolIdsForCurrentDay() {
            const startOfPatrolDay = getStartOfCurrentPatrolDay();
            const patrolsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/completedPatrols`);
            const q = query(patrolsRef, where("endTime", ">=", startOfPatrolDay), where("status", "==", "completed"));
            const querySnapshot = await getDocs(q);
            const completedIds = new Set(querySnapshot.docs.map(doc => doc.data().patrolId));
            return Array.from(completedIds);
        }

        async function promptToStartPatrol() {
            const completedPatrolIds = await getCompletedPatrolIdsForCurrentDay();
            
            const assignedSiteIds = userData.assignedSiteIds || [];
            const availablePatrols = allPatrols.filter(p => {
                if (completedPatrolIds.includes(p.id)) {
                    return false;
                }
                return p.siteId && assignedSiteIds.includes(p.siteId);
            });

            if (availablePatrols.length === 0) {
                openModal('Rondas', '<p class="text-center text-gray-600">Nenhuma ronda disponível para você no momento ou todas já foram concluídas.</p>');
                return;
            }

            let patrolListHtml = '<div class="space-y-2">';
            availablePatrols.forEach(p => {
                patrolListHtml += `
                    <button data-action="select-patrol" data-patrol-id="${p.id}" class="w-full bg-white p-4 rounded-lg flex justify-between items-center border border-[var(--border-color)] text-left hover:bg-gray-50 transition-colors">
                        <div>
                            <p class="font-bold text-[var(--text-primary)]">${p.name}</p>
                            <p class="text-sm text-[var(--text-secondary)]">${p.checkpoints.length} ponto(s) • ${p.timeLimitMinutes || 'N/A'} min</p>
                        </div>
                         <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                `;
            });
            patrolListHtml += '</div>';
            openModal('Selecione um Roteiro de Ronda', patrolListHtml);
        }

        function startPatrol(patrol) {
            const startTime = new Date();
            const timeLimitMs = (patrol.timeLimitMinutes || 120) * 60 * 1000;

            activePatrolSession = {
                patrolId: patrol.id,
                patrolName: patrol.name,
                startTime: startTime.toISOString(),
                requiredCheckpoints: patrol.checkpoints,
                scannedCheckpoints: [],
                events: [],
                photoCount: 0,
                expiresAt: new Date(startTime.getTime() + timeLimitMs).toISOString()
            };
            saveActiveSessionToLocal();
            startLiveTracking();
            showToast(`Ronda "${patrol.name}" iniciada!`);
            loadGuardDashboard();
        }

        function attemptToFinalizePatrol() {
            if (!activePatrolSession) return;
            if (patrolSubmissionInProgress) {
                showToast("Finalização já em andamento...", false);
                return;
            }

            const scannedQRs = new Set(activePatrolSession.scannedCheckpoints);
            const missingCheckpoints = activePatrolSession.requiredCheckpoints.filter(cp => !scannedQRs.has(cp.qrContent));

            if (missingCheckpoints.length > 0) {
                const missingNames = missingCheckpoints.map(cp => `<li>- ${cp.name}</li>`).join('');
                openModal('Pontos Pendentes', `<p>Para finalizar a ronda, você precisa escanear os seguintes pontos:</p><ul class="list-disc list-inside mt-2 font-semibold">${missingNames}</ul>`);
            } else {
                finalizePatrol();
            }
        }

        function finalizePatrol() {
            if (patrolSubmissionInProgress) return;
            patrolSubmissionInProgress = true;
            clearInterval(patrolTimerInterval);
            stopLiveTracking();
            showToast("Finalizando ronda...");

            const savePatrolData = async (finalLocation) => {
                const finalSessionData = {
                    ...activePatrolSession,
                    startTime: new Date(activePatrolSession.startTime),
                    endTime: new Date(),
                    status: 'completed',
                    endLocation: finalLocation
                };
                delete finalSessionData.expiresAt;

                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/completedPatrols`), finalSessionData);
                    showToast("Ronda finalizada e salva!", false);
                } catch (error) {
                    showToast("Erro ao salvar a ronda. Tente novamente.", true);
                    console.error("Erro ao finalizar ronda:", error);
                    patrolSubmissionInProgress = false;
                    return;
                }
                
                activePatrolSession = null;
                patrolSubmissionInProgress = false;
                saveActiveSessionToLocal(); 
                loadGuardDashboard();   
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                    savePatrolData(location);
                },
                (error) => {
                    showToast("Localização final não obtida, mas a ronda foi salva.", false);
                    savePatrolData(null);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }

        function cancelPatrol() {
            clearInterval(patrolTimerInterval);
            stopLiveTracking();
            activePatrolSession = null;
            saveActiveSessionToLocal();
            showToast("Ronda cancelada.");
            loadGuardDashboard();
        }
        
        function saveActiveSessionToLocal() {
            if (activePatrolSession) {
                localStorage.setItem(`activePatrolSession_${appId}_${currentUser.uid}`, JSON.stringify(activePatrolSession));
            } else {
                localStorage.removeItem(`activePatrolSession_${appId}_${currentUser.uid}`);
            }
        }

        function checkForActiveSession() {
            const savedSession = localStorage.getItem(`activePatrolSession_${appId}_${currentUser.uid}`);
            if (savedSession) {
                activePatrolSession = JSON.parse(savedSession);
                startLiveTracking();
                showToast("Ronda anterior recuperada.", false);
            }
        }
        
        function startPatrolTimer() {
            if (patrolTimerInterval) clearInterval(patrolTimerInterval);

            const timerElement = document.getElementById('patrol-timer');
            if (!timerElement || !activePatrolSession || !activePatrolSession.expiresAt) {
                return;
            }

            const expiresAt = new Date(activePatrolSession.expiresAt).getTime();

            patrolTimerInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = expiresAt - now;

                if (distance < 0) {
                    clearInterval(patrolTimerInterval);
                    timerElement.textContent = "Expirado";
                    showToast("O tempo da ronda expirou. Salvando como falha.", true);
                    handleExpiredPatrol();
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerElement.textContent = 
                    String(hours).padStart(2, '0') + ":" + 
                    String(minutes).padStart(2, '0') + ":" + 
                    String(seconds).padStart(2, '0');
            }, 1000);
        }

        async function handleExpiredPatrol() {
            if (!activePatrolSession) return;

            clearInterval(patrolTimerInterval);
            stopLiveTracking();
            patrolSubmissionInProgress = true;

            const expiredSession = {
                ...activePatrolSession,
                endTime: new Date(),
                startTime: new Date(activePatrolSession.startTime),
                status: 'expired'
            };
            delete expiredSession.expiresAt;

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/completedPatrols`), expiredSession);
                showToast("Ronda expirada foi salva para relatório.", false);
            } catch (error) {
                showToast("Erro ao salvar a ronda expirada.", true);
                console.error("Erro ao salvar ronda expirada:", error);
            } finally {
                activePatrolSession = null;
                patrolSubmissionInProgress = false;
                saveActiveSessionToLocal();
                loadGuardDashboard();
            }
        }

        function renderLocationStatus(container, status) {
            const locationContainer = container.querySelector('#location-status-container');
            if (!locationContainer) return;
            let content = '';
            if (status === 'granted') {
                 content = `<div class="bg-green-100 border border-green-200 text-green-800 p-3 rounded-lg flex items-center justify-center text-sm gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>Localização: <span class="font-bold">Ativa</span></span>
                    </div>`;
            } else {
                content = `<div class="p-4 bg-red-100 text-red-800 rounded-lg text-center border border-red-200">
                        <p class="font-bold">Localização Desativada (Obrigatório)</p>
                        <p class="text-sm mt-1">Permita o acesso à localização para registrar rondas.</p>
                    </div>`;
            }
            locationContainer.innerHTML = content;
        }

        async function checkAndRenderLocationStatus(container) {
            if (navigator.permissions) {
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    renderLocationStatus(container, permissionStatus.state);
                    permissionStatus.onchange = () => renderLocationStatus(container, permissionStatus.state);
                } catch (e) {
                    renderLocationStatus(container, 'default');
                }
            } else {
                renderLocationStatus(container, 'default');
            }
        }

        function requestInitialLocationPermission() {
             navigator.geolocation.getCurrentPosition(
                (position) => { checkAndRenderLocationStatus(document.body); },
                (error) => { checkAndRenderLocationStatus(document.body); },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
            );
        }

        async function startCamera(mode) {
             if (!activePatrolSession && mode !== 'test') {
                showToast("Você precisa iniciar uma ronda primeiro.", true);
                return;
            }
            cameraContainer.classList.remove('hidden');
            try {
                if (mode === 'photo') {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    videoPreview.srcObject = videoStream;
                    videoPreview.play();
                    videoPreview.classList.remove('hidden');
                    document.getElementById('capture-button').classList.remove('hidden');
                } else if (mode === 'qr') {
                    qrScanner = new Html5Qrcode("qr-reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    await qrScanner.start({ facingMode: "environment" }, config, onQrScanSuccess, (err) => {});
                }
            } catch (err) {
                showToast("Não foi possível acessar a câmera.", true);
                stopCamera();
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (qrScanner && qrScanner.isScanning) {
                qrScanner.stop().catch(err => {});
            }
            cameraContainer.classList.add('hidden');
            videoPreview.classList.add('hidden');
            document.getElementById('capture-button').classList.add('hidden');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function onQrScanSuccess(decodedText) {
            stopCamera();
            if (!activePatrolSession) return;

            const RAIO_PERMITIDO_EM_METROS = 20;

            const requiredCheckpoint = activePatrolSession.requiredCheckpoints.find(c => c.qrContent === decodedText);
            if (!requiredCheckpoint) {
                return showToast("QR Code inválido para esta ronda.", true);
            }

            if (activePatrolSession.scannedCheckpoints.includes(decodedText)) {
                return showToast(`Ponto "${requiredCheckpoint.name}" já verificado.`, false);
            }

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/checkpoints`), where("qrContent", "==", decodedText));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    return showToast("Ponto não encontrado no sistema.", true);
                }

                const checkpointDoc = querySnapshot.docs[0];
                const checkpointData = checkpointDoc.data();

                if (checkpointData.location) {
                    showToast("Verificando localização...", false);
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            const distancia = calculateDistance(latitude, longitude, checkpointData.location.latitude, checkpointData.location.longitude);

                            if (distancia <= RAIO_PERMITIDO_EM_METROS) {
                                showToast(`Ponto verificado: ${checkpointData.name}`);
                                activePatrolSession.scannedCheckpoints.push(decodedText);
                                saveEvent({ type: 'qrScan', qrData: decodedText, checkpointName: checkpointData.name });
                            } else {
                                showToast(`Você não está no local correto. Distância: ${Math.round(distancia)} metros.`, true);
                            }
                        },
                        (error) => {
                            showToast("Não foi possível obter sua localização. Tente novamente.", true);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    showToast(`Ponto verificado: ${checkpointData.name}`);
                    activePatrolSession.scannedCheckpoints.push(decodedText);
                    saveEvent({ type: 'qrScan', qrData: decodedText, checkpointName: checkpointData.name });
                }
            } catch (error) {
                showToast("Erro ao verificar o ponto. Tente novamente.", true);
                console.error("Erro no geofencing: ", error);
            }
        }

        function capturePhoto() {
             if (!activePatrolSession) { stopCamera(); return; }
             if (activePatrolSession.photoCount >= 15) {
                showToast("Limite de 15 fotos por ronda atingido.", true);
                stopCamera();
                return;
             }

            const context = photoCanvas.getContext('2d');
            photoCanvas.width = videoPreview.videoWidth;
            photoCanvas.height = videoPreview.videoHeight;
            context.drawImage(videoPreview, 0, 0, photoCanvas.width, photoCanvas.height);
            stopCamera();
            
            capturedPhotoBase64 = photoCanvas.toDataURL('image/jpeg', 0.7);
            
            document.getElementById('photo-preview-img').src = capturedPhotoBase64;
            photoPreviewContainer.classList.remove('hidden');
        }

        function confirmPhoto() {
            if (capturedPhotoBase64) {
                activePatrolSession.photoCount++;
                saveEvent({ type: 'photo', photoBase64: capturedPhotoBase64 });
                capturedPhotoBase64 = null;
                photoPreviewContainer.classList.add('hidden');
            }
        }

        function saveEvent(data) {
             navigator.geolocation.getCurrentPosition(
                (position) => {
                    const eventData = {
                        timestamp: new Date(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        ...data
                    };
                    activePatrolSession.events.push(eventData);
                    saveActiveSessionToLocal();
                    loadGuardDashboard(); 
                },
                (error) => {
                    showToast("Não foi possível obter a localização para este registro.", true);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
            );
        }

        async function loadAllPatrols() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/patrols`));
                onSnapshot(q, (querySnapshot) => {
                    allPatrols = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                     const dashboardScreen = document.getElementById('guard-dashboard-screen');
                    if (dashboardScreen && dashboardScreen.parentElement.id !== 'screen-templates') {
                        loadGuardDashboard();
                    }
                });
            } catch (e) {
                showToast("Erro ao carregar roteiros de ronda.", true);
            }
        }
        
        async function loadAllSites() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/sites`));
                const querySnapshot = await getDocs(q);
                allSites = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            } catch (e) {
                console.error("Erro ao carregar usinas para seleção:", e);
                allSites = [];
            }
        }
        
        async function loadGuardHistory() {
            const container = screens.guardHistory;
            await showPatrolsForUser(currentUser.uid, container);
        }

        function safeTimestampToDate(ts) {
            if (!ts) return new Date();
            if (typeof ts.toDate === 'function') return ts.toDate();
            if (ts.seconds) return new Date(ts.seconds * 1000);
            return new Date(ts);
        }

        async function showPatrolsForUser(userId, container) {
            container.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/completedPatrols`), orderBy("endTime", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ronda encontrada.</p>';
                    return;
                }
                
                const patrolsByDate = {};
                const patrolDocs = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));

                patrolDocs.forEach(patrol => {
                    const date = safeTimestampToDate(patrol.endTime).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!patrolsByDate[date]) patrolsByDate[date] = [];
                    patrolsByDate[date].push(patrol);
                });

                let datesHtml = '<div class="space-y-2">';
                for (const date in patrolsByDate) {
                    datesHtml += `<div class="bg-white p-4 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border border-[var(--border-color)]" data-date-key="${date}">
                           <p class="font-semibold text-[var(--text-primary)] flex justify-between items-center">${date} <span class="text-sm font-normal text-white bg-[var(--primary-blue)] px-2 py-0.5 rounded-full">${patrolsByDate[date].length}</span></p>
                        </div>`;
                }
                datesHtml += '</div>';
                container.innerHTML = datesHtml;
                container.querySelectorAll('[data-date-key]').forEach(el => {
                    el.addEventListener('click', () => {
                        const dateKey = el.dataset.dateKey;
                        openModal(`Rondas de ${dateKey}`, null, {
                            renderer: (c) => showPatrolsForDate(c, dateKey, patrolsByDate[dateKey]),
                        });
                    });
                });
            } catch (error) {
                console.error("Erro ao carregar rondas para usuário:", error);
                container.innerHTML = `<p class="text-center text-red-500">Erro ao carregar rondas.</p>`;
            }
        }

        function showPatrolsForDate(container, date, patrols) {
            let patrolsHtml = '<div class="space-y-2">';
            patrols.forEach((patrol, index) => {
                const startTime = safeTimestampToDate(patrol.startTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const endTime = safeTimestampToDate(patrol.endTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const eventCounts = patrol.events.reduce((acc, event) => { acc[event.type] = (acc[event.type] || 0) + 1; return acc; }, { qrScan: 0, photo: 0 });

                patrolsHtml += `<button class="w-full bg-white p-3 rounded-lg flex justify-between items-center border border-[var(--border-color)] text-left hover:bg-gray-50" data-patrol-index="${index}">
                        <div class="overflow-hidden">
                            <p class="font-bold text-[var(--text-primary)] truncate">${patrol.patrolName}</p>
                            <p class="text-sm text-[var(--text-secondary)]">Início: ${startTime} | Fim: ${endTime}</p>
                             <p class="text-sm text-[var(--text-secondary)]">Registros: ${eventCounts.qrScan} QR / ${eventCounts.photo} Fotos</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>`;
            });
            patrolsHtml += '</div>';
            container.innerHTML = patrolsHtml;
            container.querySelectorAll('[data-patrol-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const patrolData = patrols[parseInt(el.dataset.patrolIndex)];
                    openModal(`Detalhes da Ronda: ${patrolData.patrolName}`, null, {
                        renderer: (c) => showPatrolDetails(c, patrolData)
                    });
                });
            });
        }

        function showPatrolDetails(container, patrol) {
            const qrScans = patrol.events.filter(e => e.type === 'qrScan').sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
            const photos = patrol.events.filter(e => e.type === 'photo');
            const locations = patrol.events.filter(e => e.latitude && e.longitude).map(e => [e.latitude, e.longitude, 0.8]);

            let detailsHtml = '<div class="space-y-6">';
            detailsHtml += '<div><h4 class="font-bold mb-2 text-base text-[var(--text-secondary)]">Mapa de Calor</h4><div id="heatmap-container" class="bg-gray-200 h-64 w-full rounded-lg"></div></div>';
            if (qrScans.length > 0) {
                detailsHtml += '<div><h4 class="font-bold mb-2 text-base text-[var(--text-secondary)]">Pontos Registrados</h4><div class="space-y-2">';
                qrScans.forEach(scan => {
                    const time = safeTimestampToDate(scan.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    detailsHtml += `<div class="bg-white p-3 rounded-lg border border-[var(--border-color)]">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-sm">${scan.checkpointName} <span class="text-xs text-gray-500">(${scan.qrData})</span></p>
                                <span class="font-bold text-sm text-[var(--primary-blue)]">${time}</span>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                Local: <a href="https://www.google.com/maps/search/?api=1&query=${scan.latitude},${scan.longitude}" target="_blank" class="text-blue-600 hover:underline">${scan.latitude.toFixed(4)}, ${scan.longitude.toFixed(4)}</a>
                            </div>
                        </div>`;
                });
                detailsHtml += '</div></div>';
            }
            if (photos.length > 0) {
                detailsHtml += `<div><h4 class="font-bold mb-2 text-base text-[var(--text-secondary)]">Fotos</h4><div id="photo-grid" class="grid grid-cols-3 gap-2">`;
                photos.forEach((p, index) => {
                    detailsHtml += `<img src="${p.photoBase64}" class="w-full h-32 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity cursor-pointer" data-photo-index="${index}">`;
                });
                detailsHtml += '</div></div>';
            }
            detailsHtml += '</div>';
            container.innerHTML = detailsHtml;

            container.querySelectorAll('[data-photo-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const photo = photos[parseInt(el.dataset.photoIndex)];
                    openModal('Foto da Ronda', `<img src="${photo.photoBase64}" class="w-full h-auto rounded-lg">`);
                });
            });

            if (locations.length > 0) {
                setTimeout(() => {
                    try {
                        const mapContainer = document.getElementById('heatmap-container');
                        if (mapContainer && mapContainer.offsetParent !== null && !mapContainer._leaflet_id) {
                           mapInstance = L.map('heatmap-container').setView(locations[0], 15);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(mapInstance);
                            L.heatLayer(locations, {radius: 25, blur: 15, maxZoom: 17}).addTo(mapInstance);
                            mapInstance.invalidateSize();
                        }
                    } catch(e) { console.error("Erro ao iniciar o mapa:", e); }
                }, 150);
            } else {
                 if(document.getElementById('heatmap-container')) document.getElementById('heatmap-container').innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum dado de localização para exibir.</p>';
            }
        }
        
        function updateNavigation() {
            const guardNavItems = `
                <a href="#" data-nav="guardDashboard" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" data-nav="guardHistory" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Minhas Rondas</span>
                </a>
                <a href="#" data-nav="profile" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span>Meu Perfil</span>
                </a>`;
            document.getElementById('side-menu-nav-mobile').innerHTML = guardNavItems;
            document.getElementById('guard-desktop-nav').innerHTML = guardNavItems;
        }

        function handleNavigation(e, navTarget, navTitle) {
            if (e) e.preventDefault();
            const targetEl = e ? e.target.closest('[data-nav]') : null;
            if (!targetEl && !navTarget) return;

            const screenName = navTarget || targetEl.dataset.nav;
            const title = navTitle || targetEl.querySelector('span').textContent;

            if (!screenName) return;

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll(`[data-nav=${screenName}]`).forEach(item => item.classList.add('active'));

            const screenMap = {
                profile: { load: loadProfile },
                guardDashboard: { load: loadGuardDashboard },
                guardHistory: { load: loadGuardHistory },
            };

            navigateToScreen(screenName, title);
            if (screenMap[screenName]?.load) {
                screenMap[screenName].load();
            }

            if (e && e.currentTarget.id === 'side-menu-nav-mobile') {
                closeSideMenu();
            }
        }

        function loadProfile() {
            const container = screens.profile;
            container.innerHTML = `
                <div class="space-y-6 max-w-md mx-auto">
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Nome Completo</label>
                        <input id="profile-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Email</label>
                        <p id="profile-email-display" class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg"></p>
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Função</label>
                        <p id="profile-role-display" class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg capitalize"></p>
                    </div>
                </div>
                <button id="save-profile-button" class="w-full mt-8 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg hover:bg-[var(--accent-blue)] transition-colors max-w-md mx-auto block">Salvar Alterações</button>`;
            
            container.querySelector('#profile-name-input').value = userData.name || '';
            container.querySelector('#profile-email-display').textContent = userData.email;
            container.querySelector('#profile-role-display').textContent = userData.role;
            container.querySelector('#save-profile-button').addEventListener('click', async () => {
                const newName = container.querySelector('#profile-name-input').value;
                if (newName && newName !== userData.name) {
                    try {
                        await updateDoc(doc(db, "users", currentUser.uid), { name: newName });
                        userData.name = newName;
                        showToast("Perfil atualizado com sucesso!");
                        if (document.querySelector('.text-4xl.font-extrabold')) {
                            document.querySelector('.text-4xl.font-extrabold').textContent = `${newName.split(' ')[0]}!`;
                        }
                    } catch (error) { showToast("Erro ao atualizar perfil.", true); }
                }
            });
        }

        async function checkForAlerts() {
            try {
                onSnapshot(doc(db, `artifacts/${appId}/public/data/alerts`, "latest"), (alertDoc) => {
                    if (alertDoc.exists()) {
                        const alertData = alertDoc.data();
                        const lastReadTimestamp = userData.lastAlertReadTimestamp || 0;

                        if (alertData.timestamp.seconds > lastReadTimestamp) {
                            const bells = document.querySelectorAll('#notification-bell-mobile, #notification-bell-desktop');
                            const dots = document.querySelectorAll('#notification-dot-mobile, #notification-dot-desktop');
                            
                            bells.forEach(bell => {
                                bell.classList.remove('hidden');
                                bell.onclick = async () => {
                                    openModal('Último Alerta', `<p class="text-lg">${alertData.message}</p><p class="text-sm text-gray-500 mt-4">${safeTimestampToDate(alertData.timestamp).toLocaleString('pt-BR')}</p>`);
                                    dots.forEach(dot => dot.classList.add('hidden'));
                                    
                                    const userRef = doc(db, "users", currentUser.uid);
                                    await updateDoc(userRef, { lastAlertReadTimestamp: alertData.timestamp.seconds });
                                    userData.lastAlertReadTimestamp = alertData.timestamp.seconds;
                                };
                            });
                            dots.forEach(dot => dot.classList.remove('hidden'));
                        }
                    }
                });
            } catch (error) {
                console.error("Error checking for alerts:", error);
            }
        }

        function confirmAndSendPanicAlert() {
            openModal('Alerta de Pânico', `
                <p class="text-center text-lg">Você está prestes a enviar um alerta de emergência para a central. Deseja continuar?</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button>
                    <button id="confirm-panic-button" class="px-4 py-2 rounded-lg bg-[var(--danger-red)] text-white">Sim, Enviar Alerta!</button>
                </div>
            `);
            document.getElementById('confirm-panic-button').onclick = () => {
                sendPanicAlert();
                closeModal();
            };
        }

        function sendPanicAlert() {
            showToast("Enviando alerta de pânico...");
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    const alertData = {
                        userId: currentUser.uid,
                        userName: userData.name,
                        location: { latitude, longitude },
                        timestamp: new Date()
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/panicAlerts`), alertData);
                        showToast("Alerta de pânico enviado com sucesso!", false);
                    } catch (error) {
                        console.error("Erro ao enviar alerta de pânico:", error);
                        showToast("Falha ao enviar o alerta.", true);
                    }
                },
                (error) => {
                    console.error("Erro ao obter localização para pânico:", error);
                    showToast("Não foi possível obter sua localização. Alerta não enviado.", true);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function startLiveTracking() {
            if (liveLocationInterval) clearInterval(liveLocationInterval);
            
            updateGuardLocation();
            
            liveLocationInterval = setInterval(updateGuardLocation, 60000);
        }

        function stopLiveTracking() {
            if (liveLocationInterval) {
                clearInterval(liveLocationInterval);
                liveLocationInterval = null;
                const guardStatusRef = doc(db, `artifacts/${appId}/public/data/liveGuards`, currentUser.uid);
                setDoc(guardStatusRef, { status: 'inactive' }, { merge: true });
            }
        }

        function updateGuardLocation() {
            if (!currentUser) return;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const guardStatusRef = doc(db, `artifacts/${appId}/public/data/liveGuards`, currentUser.uid);
                    
                    const statusData = {
                        userId: currentUser.uid,
                        userName: userData.name,
                        location: { latitude, longitude },
                        lastUpdate: new Date(),
                        status: activePatrolSession ? 'on-patrol' : 'idle',
                        patrolName: activePatrolSession ? activePatrolSession.patrolName : null
                    };

                    setDoc(guardStatusRef, statusData, { merge: true });
                },
                (error) => {
                    console.warn("Não foi possível atualizar a localização ao vivo:", error.message);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
            );
        }
    </script>
</body>
</html>
